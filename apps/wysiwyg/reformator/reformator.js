// Reformator 2.0
// Copyright Art. Lebedev | http://www.artlebedev.ru/
// Updated 2015-08-05 Vladimir Tokmakov <vlalek>
var reformator={auto:function(a){if(!a){a={}}if(!a.class_name){a.class_name='(X?HTML|x?html)'}this.init_by_tag('textarea',a);this.init_by_tag('input',a)},forms:[],children:[],elements_by_tag_name:{},elements_by_class_name:{nbsp:{}},sidebar_file_name:'sidebar.html',init_class:function(a){this[a.name]={};this[a.name].object=a.object;this[a.name].object.prototype=a.prototype},init:function(a){if(!a){a={}}if(!this.inited){if(!reformator.html.inited){reformator.html.init()}for(var s in this){if(this.constructor.prototype[s])continue;if(this[s].init){this[s].init()}}}if(a.root_path){this.root_path=a.root_path}else{var b=document.getElementsByTagName('script'),matches,i=0;while(i<b.length&&!matches){matches=b[i].src.match(/^(.*)reformator.*\.js$/);i++};this.root_path=matches?matches[1]:'./'}if(a.css_path){this.css_path=a.css_path}else{this.css_path=this.root_path+'editor.css'}if(a.bar_path){this.bar_path=a.bar_path}else{this.bar_path=this.root_path+this.sidebar_file_name}var c=navigator.userAgent.toLowerCase();var d=/(webkit)[ \/]([\d]*)/.exec(c)||/(opera)(?:.*version)?[ \/]([\d]*)/.exec(c)||/(msie) ([\d]*)/.exec(c)||c.indexOf('compatible')<0&&/(mozilla)(?:.*? rv:([\d]*))?/.exec(c)||['','',''];this.browser={name:d[1],mversion:d[2]};this.inited=true},init_by_tag:function(a,b){var c=b.from_element?b.from_element:document;var d=c.getElementsByTagName(a);for(var i=0;i<d.length;i++){if(reformator.dom_element.has_class(d[i],b.class_name)&&!reformator.dom_element.has_class(d[i],'reformator_source')){this.append(d[i],b)}}},append:function(a,b){if(!this.inited){this.init(b)}var c=new reformator.editor(a,b);if(c&&c.element&&c.element.parentNode){this.children[this.children.length]=c;var d=reformator.dom_element.get_first_ancestor_element(a,'form');if(d){var e=true;for(var i=0;i<this.forms.length;i++){if(this.forms[i].element==d){e=false;this.forms[i].children[this.forms[i].children.length]=c}}if(e){var f={element:d,children:[c]};this.forms[this.forms.length]=f;reformator.dom_element.add_event_listener(d,'submit',function(){for(var i=0;i<f.children.length;i++){f.children[i].on_submit()}})}}if(!this.bar.created&&b&&b.bar){this.bar.create()}}return c},remove:function(a){for(var i=0;i<this.children.length;i++){if(this.children[i].source.element==a){this.children[i].destroy()}}}};reformator.editor=function(a,b){if(a.reformator){return a.reformator}a.reformator=this;this.create(a,b)};reformator.editor.prototype={create:function(a,b){this.init_variables();var p={},s;if(b){for(s in b){p[s]=b[s]}}if(typeof(p.inline_only)=='undefined'&&(a.tagName.toLowerCase()=='input'||reformator.dom_element.has_class(a,'(inline|INLINE)'))){p.inline_only=true}if(p.inline_only&&!p.control_class){p.control_class='inline'}for(s in p){if(p.constructor.prototype[s])continue;if(typeof(this[s])=='undefined'||typeof(this[s])==p[s]){this[s]=p[s]}}if(a.id){var c=document.getElementsByTagName('label');for(var i=0;i<c.length;i++){if(c[i].htmlFor==a.id){this.label=c[i];break}}}this.overflow=reformator.dom_element.get_style(a,'overflow');this.element=this.make(a);this.element.reformator=this;this.source=new reformator.source(a);var d=this.source.get();if(d&&(d.indexOf(this.autotypograph_cancel_label)>-1||d.indexOf(this.autoclear_cancel_label)>-1)){this.set_autoformat(false)}this.wysiwyg=new reformator.wysiwyg(this,this.element.getElementsByTagName('iframe')[0],d,p);this.resizer={element:this.element.getElementsByTagName('ins')[0]};var t=this;setTimeout(function(){t.init();if(b.focus){setTimeout(function(){try{t.wysiwyg.selection.select_node(t.wysiwyg.document.body);t.wysiwyg.selection.collapse(true);t.wysiwyg.focus()}catch(e){}},300)}},0);if(!reformator.dom_element.has_class(document.body.parentNode,'with_reformator')){reformator.dom_element.add_class(document.body.parentNode,'with_reformator')}},destroy:function(){if(this.element&&this.element.parentNode&&this.source&&this.source.element){this.element.parentNode.insertBefore(this.source.element,this.element);this.source.element.className=this.element.className.replace(/\sreformator\S*/g,'');var a=this.element.getAttribute('style');reformator.dom_element.set_style(this.source.element,a&&a.cssText?a.cssText:a);this.element.parentNode.removeChild(this.element)}},init_variables:function(){this.autoformat=true;this.autotypograph=true;this.autotypograph_cancel_label='<!-- no autotypograph -->';this.autoclear=true;this.autoclear_cancel_label='<!-- no autoclear -->'},make:function(a){var b=document.createElement('div');var c=a.getAttribute('style');reformator.dom_element.set_style(b,c&&c.cssText?c.cssText:c);reformator.dom_element.set_style(a,'');b.className=a.className+' reformator reformator_inactive';a.className='reformator_source';b.innerHTML='<iframe frameborder="no" class="reformator_wysiwyg" style="display: none;"></iframe><div class="min"></div><ins class="resizer"></ins>';b.unselectable='on';a.parentNode.insertBefore(b,a);b.appendChild(a);return b},init:function(){var t=this;this.resizer.resize=function(a){t.element.style.height=t.resizer.start.height+reformator.dom_element.get_coords(a).top-t.resizer.start.top+'px';t.resized=true};reformator.dom_element.add_event_listener(this.resizer.element,'mousedown',function(b){reformator.dom_element.add_class(t.resizer.element,'resizer_active');t.resizer.start={top:reformator.dom_element.get_coords(b).top,height:t.element.offsetHeight};reformator.dom_element.add_event_listener(document,'mousemove',t.resizer.resize);reformator.dom_element.add_event_listener(document,'mouseup',function(a){reformator.dom_element.remove_class(t.resizer.element,'resizer_active');reformator.dom_element.remove_event_listener(document,'mousemove',t.resizer.resize)});reformator.dom_element.cancel_event(b)});this.current=this.wysiwyg;this.actived=true;this.init_input_events(true)},init_input_events:function(b){var t=this;if(b){reformator.dom_element.add_event_listener(this.source.element,['mouseup','keyup','drop','paste'],function(a){t.set_edited(true)});reformator.dom_element.add_event_listener(this.source.element,'focus',function(){t.on_focus(t.wysiwyg,t.source)})}var c=[window.addEventListener?this.wysiwyg.window:this.wysiwyg.document];if(b){c[c.length]=this.source.element}reformator.dom_element.add_event_listener(c,'keydown',function(a){a=reformator.dom_element.normalize_event(a);if(a.ctrlKey&&a.altKey){if(a.key_code==13){t.set_maximize(!t.maximize);t.focus()}else if(a.key_code==85){t.set_active(!t.actived);t.focus()}}});var c=[this.wysiwyg.window];if(window.addEventListener){c[c.length]=this.wysiwyg.document}reformator.dom_element.add_event_listener(c,'focus',function(){t.wysiwyg.set_design_mode();t.on_focus(t.source,t.wysiwyg)});if(b){c[c.length]=this.source.element}reformator.dom_element.add_event_listener(c,'blur',function(a){t.on_blur()});setTimeout(function(){reformator.dom_element.remove_class(t.element,'reformator_inactive');t.wysiwyg.element.style.display='block';function init_resize(){if(t.wysiwyg.document.body.scrollHeight&&t.element.offsetHeight){function resize(){if(t.resized){return}if(t.wysiwyg.document.body.scrollHeight>t.element.offsetHeight){t.element.style.height=t.wysiwyg.document.body.scrollHeight+20+'px'}else{var a=t.wysiwyg.document.body.offsetHeight>t.wysiwyg.document.body.scrollHeight?t.wysiwyg.document.body.scrollHeight:t.wysiwyg.document.body.offsetHeight;if(a+50<t.element.offsetHeight){t.element.style.height=a+50+'px'}}};resize();reformator.dom_element.add_event_listener(window.addEventListener?t.wysiwyg.window:t.wysiwyg.document,['keyup','mouseup','DOMAttrModified','selectionchange'],resize)}else{setTimeout(init_resize,500)}};setTimeout(init_resize,500)},0)},set_active:function(a){this.actived=a;if(this.actived){this.current=this.wysiwyg}else{this.current=this.source}},focus:function(){this.current.focus()},on_focus:function(a,b){if(!this.focused){if(reformator.current&&reformator.current!=this){reformator.current.on_blur()}reformator.current=this;this.focused=true;if(this.control_class&&reformator.control.element){reformator.dom_element.add_class(reformator.control.element,this.control_class)}reformator.dom_element.add_class(this.element,'reformator_current');if(a.edited){b.set(a.get());a.set_edited(false)}reformator.dom_element.replace_class(this.element,'reformator_inactive','',!this.actived);if(this.actived){this.wysiwyg._update_selection()}else{reformator.control.refresh()}}},on_blur:function(){if(this.focused){this.focused=false;reformator.dom_element.remove_class(this.element,'reformator_current');if(this.control_class&&reformator.control.element){reformator.dom_element.remove_class(reformator.control.element,this.control_class)}reformator.control.refresh()}window.status=''},on_submit:function(){if(this.wysiwyg.edited){this.source.set(this.wysiwyg.get())}this.current=this.source;var i=this.source.element.value?this.source.element.value.indexOf(this.autotypograph_cancel_label):-1;if(this.autotypograph){if(this.edited){this.typograph()}if(i>-1){this.source.element.value=this.source.element.value.substr(0,i)}}else if(i==-1){this.source.element.value+=this.autotypograph_cancel_label}i=this.source.element.value?this.source.element.value.indexOf(this.autoclear_cancel_label):-1;if(this.autoclear){if(this.edited){this.clear()}if(i>-1){this.source.element.value=this.source.element.value.substr(0,i)}}else if(i==-1){this.source.element.value+=this.autoclear_cancel_label}},set_autoformat:function(a){this.autoformat=a;this.set_autotypograph(a);this.set_autoclear(a)},set_autotypograph:function(a){this.autotypograph=a},set_autoclear:function(a){this.autoclear=a},set_maximize:function(a){this.maximize=a;if(this.wysiwyg.window.getSelection&&this.actived){var b=this.wysiwyg.window.getSelection(),saved_selection=b?b.getRangeAt(0):null;this.source.element.focus()}if(this.maximize){reformator.dom_element.add_class(document.body,'reformator_maximize');reformator.dom_element.add_class(this.element,'reformator_maximized');if(this.label){reformator.dom_element.add_class(this.label,'reformator_maximized_label');reformator.dom_element.add_class(this.element,'reformator_maximized_with_label')}}else{reformator.dom_element.remove_class(document.body,'reformator_maximize');reformator.dom_element.remove_class(this.element,'reformator_maximized');if(this.label){reformator.dom_element.remove_class(this.label,'reformator_maximized_label');reformator.dom_element.remove_class(this.element,'reformator_maximized_with_label')}}if(this.wysiwyg.window.getSelection){for(var i=0;i<reformator.children.length;i++){reformator.children[i].wysiwyg.document.body.contentEditable=false;reformator.children[i].wysiwyg.document.body.contentEditable=true}if(this.actived){b=this.wysiwyg.window.getSelection();b.removeAllRanges();b.addRange(saved_selection);this.focus()}}},typograph:function(){this.set(reformator.typograph.process(this.get(),this.typograph_params))},clear:function(){if(this.actived){this.wysiwyg.clear()}else{if(this.source.edited){this.wysiwyg._set(this.source.get());this.wysiwyg.set_edited(false)}this.wysiwyg.clear();if(this.wysiwyg.edited){this.source.set(this.wysiwyg.get())}}},on_wysiwyg_change:function(){if(this.synchronize_timeout){clearTimeout(this.synchronize_timeout)}if(!this.wysiwyg||this.not_edit){return}var t=this;this.synchronize_timeout=setTimeout(function(){if(t.wysiwyg.edited){t.source.set(t.wysiwyg.get());t.wysiwyg.set_edited(false);t.not_edit=true;reformator.dom_element.fire_event(t.source.element,'keyup');t.not_edit=false}},3000-9000000/(t.wysiwyg.document.body.scrollHeight+3000))},get:function(){return this.current.get()},set:function(a){this.current.set(a);this.set_edited(true)},set_edited:function(a){this.edited=a;if(this.current){this.current.set_edited(a)}}};reformator.source=function(a){this.element=a};reformator.source.prototype={focus:function(){this.element.focus()},get:function(){return this.element.value},set:function(a){this.element.value=a?a:''},set_edited:function(a){this.edited=a}};reformator.wysiwyg=function(a,b,c,d){this.editor=a;this.element=b;this.create(c,d)};reformator.wysiwyg.prototype={create:function(a,b){this.init_variables();if(b){for(var s in b){if(b.constructor.prototype[s])continue;if(typeof(this[s])=='undefined'||typeof(this[s])==b[s]){this[s]=b[s]}}}this.window=this.element.contentWindow;this.document=this.window.document;this.make(a);this.ancestors=[];this.selection=new reformator.dom_selection(this.window);this.undo=new reformator.wysiwyg_undo(this);if(!a){this.set_empty();this.set_edited(true)}this.init()},init_variables:function(){this.nbsp_tag_pattern=/<nobr[^>]*class="nbsp"[^>]*>([^<]*?)<\/nobr>/g;this.nbsp_pattern=new RegExp('('+reformator.html.entities.common.nbsp[0]+'|'+reformator.html.entities.common.nbsp[1]+'|'+reformator.html.entities.common.nbsp[2]+'|'+reformator.html.entities.common.nbsp[3]+')(?![^<>]{0,200}>)','g');this.shy_pattern=new RegExp('('+reformator.html.entities.common.shy[0]+'|'+reformator.html.entities.common.shy[1]+'|'+reformator.html.entities.common.shy[2]+'|'+reformator.html.entities.common.shy[3]+')(?![^<>]{0,200}>)','g');this.empty_pattern=new RegExp('^([\\s\\n\\r]'+'|'+reformator.html.entities.common.nbsp[0]+'|'+reformator.html.entities.common.nbsp[1]+'|'+reformator.html.entities.common.nbsp[2]+'|'+reformator.html.entities.common.nbsp[3]+'|'+reformator.html.entities.common.shy[0]+'|'+reformator.html.entities.common.shy[1]+'|'+reformator.html.entities.common.shy[2]+'|'+reformator.html.entities.common.shy[3]+')*$');this.nbsp_patterns=new RegExp('(\\s*'+reformator.html.entities.common.nbsp[0]+'\\s*|\\s*'+reformator.html.entities.common.nbsp[1]+'\\s*|\\s*'+reformator.html.entities.common.nbsp[2]+'\\s*|\\s*'+reformator.html.entities.common.nbsp[3]+'\\s*){2,}','g')},make:function(a){this.document.open();this.document.write('<html><style type="text/css">'+'.nbsp {/*user-select: none; -moz-user-select: none; -khtml-user-select: none; -webkit-user-select: none;*/ height: 1em;} '+((reformator.browser.name=='webkit'&&reformator.browser.mversion>531)||(reformator.browser.name=='mozilla'&&reformator.browser.mversion>5)||(reformator.browser.name=='opera'&&reformator.browser.mversion>10)?'#reformator_selection_0, #reformator_selection_1 {display: none;} ':'')+'table, img {width: auto ! important; height: auto ! important;} '+'table, td, th {border: 0 transparent; margin: 0;} '+'table {empty-cells: show; border-spacing: 0; border-collapse: collapse; border-left: 1px solid; border-top: 1px solid;} '+'th, td {border-right: 1px solid; border-bottom: 1px solid;}'+'</style><link rel="stylesheet" type="text/css" href="'+reformator.css_path+'" /><body class="reformator">'+this.preprocess(a)+'</body></html>');this.document.close();this._cancel_submit(this.document.getElementsByTagName('form'))},init:function(){var t=this;var b=window.addEventListener?this.window:this.document;reformator.dom_element.add_event_listener(b,'unload',function(){var a=t.get();setTimeout(function(){if(!t.element.contentWindow){return}t.design_mode=false;t.create(a);t.editor.init_input_events()},0);return false});reformator.dom_element.add_event_listener(b,'keydown',function(a){a=reformator.dom_element.normalize_event(a);if(a.ctrlKey||a.metaKey){if(a.key_code==89||(a.altKey&&a.key_code==90)||(a.shiftKey&&a.key_code==90)){t.undo.forward();reformator.dom_element.cancel_event(a)}else if(a.key_code==90){t.undo.backward();reformator.dom_element.cancel_event(a)}}else if(a.key_code==9&&t.ancestors_path&&t.ancestors_path.match(/(\s|^)pre([\s\.]|$)/i)){t.insert('\t');reformator.dom_element.cancel_event(a)}else if(a.key_code==8||a.key_code==46||a.key_code==37||a.key_code==39){for(var i=0,n;i<2;i++){n=t.document.getElementById('reformator_selection_'+i);if(n){n.parentNode.removeChild(n)}}}});function on_change(a){if(a.key_code==32||a.key_code>=48){if(a.ctrlKey||a.metaKey){if(a.key_code==86||a.key_code==88){t.undo.store()}}else{t.undo.store({as_sequence:true})}}else if(a.key_code==8||a.key_code==46){t.undo.store({as_sequence:true,as_remove:true})}else{t.undo.store()}t._update_selection()};this.selection.add_on_change_function(on_change);if(t.inline_only){reformator.dom_element.add_event_listener(b,window.addEventListener?'keypress':'keydown',function(a){a=reformator.dom_element.normalize_event(a);if(a.key_code==13){reformator.dom_element.cancel_event(a)}})}reformator.dom_element.add_event_listener(b,'keyup',function(a){a=reformator.dom_element.normalize_event(a);if(a.key_code==1||(a.key_code>32&&a.key_code<41)){}else{if(a.key_code==13){t.check_for_paragraph()}else if((a.ctrlKey||a.metaKey)&&a.key_code==86){if(t.editor.autoclear){t._format_clear()}}else if(a.key_code==46||a.key_code==8||(a.ctrlKey&&a.key_code==88)){}else if(a.key_code==72&&a.altKey&&a.ctrlKey&&document.location.href.match(/vlalek/)){alert(t.document.body.innerHTML)}else if(a.key_code==68&&a.altKey&&a.ctrlKey&&document.location.href.match(/vlalek/)){var s=t.selection.get_start_node();var e=t.selection.get_end_node();var c=reformator.dom_element.get_common_sibling_nodes(s,e),cs='';if(c){for(var i=0;i<c.length;i++){cs+='\n---\n'+(c[i].tagName?c[i].tagName:c[i].nodeValue)}}alert(window.sss+'\n-------------------------------\n'+(s.tagName?(s.tagName=='INS'?s.parentNode.innerHTML:s.tagName):s.nodeValue)+'\n->\n'+(e.tagName?(e.tagName=='INS'?e.parentNode.innerHTML:e.tagName):e.nodeValue)+'\n-------------------------------\n'+cs)}t.set_edited(true)}});this.set_design_mode()},set_design_mode:function(){if(!this.design_mode){try{if((this.document.body.contentEditable+'')=='false'||(this.document.body.contentEditable+'')=='inherit'){this.document.body.contentEditable=true}else{this.document.designMode='on'}var t=this;setTimeout(function(){try{t.document.execCommand('enableObjectResizing',false,'false');t.document.execCommand('enableInlineTableEditing',false,'false')}catch(error){}},500)}catch(error){return false};this.design_mode=true}},set:function(a){var b=this.store_selection();this._set(a);this.restore_selection(b);this.undo.store()},_set:function(a){if(a){this.document.body.innerHTML=this.preprocess(a);this._cancel_submit(this.document.getElementsByTagName('form'))}else{this.set_empty()}},preprocess:function(a){return a?a.replace(this.nbsp_pattern,'<nobr class="nbsp" unselectable="on">'+reformator.html.entities.common.nbsp[0]+'</nobr>').replace(/(<nobr[^>]*>[^<]*)<nobr[^>]*>([^<]*)<\/nobr>/g,'$1$2').replace(/<\/table>(?=(\s*<\/[a-z\d]+>|<!--.*?-->)*\s*$)/g,'</table>&nbsp;'):''},get:function(){return reformator.dom_element.get_inner_html(this.document.body).replace(this.nbsp_tag_pattern,function(s,a){return a.replace(/\s+/g,'&nbsp;')}).replace(this.nbsp_pattern,'&nbsp;').replace(/(^\s+|\s+$)/g,'').replace(/<br\s*\/>\s*($|<\/p>)/,'$1').replace(/\s*<p>(\s*<br\s*\/>\s*)?<\/p>\s*/g,'').replace(this.shy_pattern,'&shy;')},focus:function(){if(window.addEventListener){this.element.focus()}this.window.focus()},check_for_paragraph:function(){if(!this.inline_only&&(!this.ancestors||!this.ancestors.length)){this.format({selector:{elements:[{tag_name:'p'}]}});this._update_selection()}},clear:function(){this._format_clear();this.undo.store();this._update_selection()},insert:function(a,b,c,d){if(this.selection.selection&&this.selection.selection.type=='Control'){this.selection.select_node(this.selection.range.item(0))}this.focus();this._update_selection();if(!b){if(this.selection.range.pasteHTML){this.selection.range.pasteHTML('')}else{this.selection.range.deleteContents()}this.selection.collapse(true)}if(b&&(d||!this.selection.collapsed())){var e=d?this._format_block({tag_name:'div'}):this._format_inline({tag_name:'span'});if(e){for(var i=0;i<e.length;i++){e[i].innerHTML=a+(b?(c?e[i].innerText||e[i].textContent||' ':e[i].innerHTML)+b:'');this._replace_element_by_null(e[i])}}}else{if(this.selection.range.pasteHTML){var f=false;if(this.ancestors_path&&this.ancestors_path.match(/(\s|^)pre([\s\.]|$)/i)){a=a?a.replace(/(\t+)/g,'<pre id="reformator_tab" style="display: inline">$1</pre>'):'';b=b?b.replace(/(\t+)/g,'<pre id="reformator_tab" style="display: inline">$1</pre>'):'';f=true}this.selection.range.pasteHTML(a+(b?b:''));if(f){while(tab=this.document.getElementById('reformator_tab')){this._replace_element_by_null(tab)}}}else{var g=this.document.createElement('span');g.innerHTML=a+(b?b:'');this.selection.range.insertNode(g);this.selection.select_node(g);this.selection.collapse(false);this._replace_element_by_null(g)}}this.set_edited(true);this.undo.store();this._update_selection()},format:function(a){if(this.selection.selection&&this.selection.selection.type=='Control'){var b=this.selection.range.item(0);this.selection.select_node(b)}else{this.focus();var b=this.store_selection()}this.focus();this._update_selection();var c={tag_name:a.selector.elements[0].tag_name,class_name:a.selector.elements[0].class_name?a.selector.elements[0].class_name:'',id:a.selector.elements[0].id,attributes:a.attributes};switch(c.tag_name){case'ul':this.document.execCommand('insertunorderedlist',null,null);break;case'ol':this.document.execCommand('insertorderedlist',null,null);break;case'li':var d=reformator.dom_element.get_common_sibling_nodes(this.selection.get_start_node(),this.selection.get_end_node());if(d[0]&&(!d[0].tagName||d[0].tagName.toLowerCase()!='li')){d=[reformator.dom_element.get_first_ancestor_element(d[0],'li')]}if(d[0]){var e=reformator.dom_element.get_first_previous_sibling_element(d[0],'li');if(e){var f=this.document.createElement(window.addEventListener?d[0].parentNode.tagName:'<'+d[0].parentNode.tagName+'>');e.appendChild(f);for(var i=0;i<d.length;i++){f.appendChild(d[i])}}else{var g=d[0].parentNode;var h=g.parentNode;if(h.tagName.toLowerCase()=='li'){h.parentNode.appendChild(this.document.createTextNode(''));reformator.dom_element.move_children_before(g,h.nextSibling);g.parentNode.removeChild(g)}}}break;case'th':var j=this.find_suitable_ancestor_element({selector:reformator.css.parse_selector('tr > *')});if(j){var f=this._replace_element_by_new(j,reformator.html.tags.all[j.tagName].name=='th'?'td':'th');this._format_apply_params(f,c)}break;default:var j=this.find_suitable_ancestor_element({selector:a.selector});if(j&&(this.selection.collapsed()||this.selection.get_type()=='element')){ancestor_tag=reformator.html.tags.all[j.tagName];if(c.tag_name&&ancestor_tag&&ancestor_tag.name==c.tag_name&&(!c.class_name||(j.className.match(new RegExp('^\\s*'+c.class_name+'\\s*$'))&&c.tag_name!='table'))&&a.remove!=false){this._replace_element_by_null(j)}else{this._format_apply_params(j,c)}}else{if(a.selector.elements[a.selector.elements.length-1].tag_name=='table'){var k=this._format_table(c)}else{var l=reformator.html.tags.all[c.tag_name],k;k=c.tag_name&&l&&l.block&&!l.empty?this._format_block(c):this._format_inline(c)}if(k&&k.length){for(var i=0;i<k.length;i++){this._format_apply_params(k[i],c)}}}}this.set_edited(true);this.restore_selection(b);this.undo.store();this._update_selection()},find_suitable_ancestor_element:function(a){var b=a.selector.elements;var c=null,i,ii,iii,iv,ancestor_tag;for(i=0;i<this.ancestors.length;i++){ancestor_tag=reformator.html.tags.all[this.ancestors[i].tagName];if(!b[0].tag_name||(ancestor_tag&&ancestor_tag.name==b[0].tag_name)){c=this.ancestors[i]}if(b[0].class_name){for(ii=i;ii<this.ancestors.length;ii++){if(reformator.dom_element.has_class(this.ancestors[ii],b[0].class_name)){c=this.ancestors[ii];break}}}if(c){iv=i+1;for(ii=1,iii=1;ii<b.length;ii++){while(this.ancestors[iv]){ancestor_tag=reformator.html.tags.all[this.ancestors[iv].tagName];if((!b[ii].tag_name||(ancestor_tag&&ancestor_tag.name==b[ii].tag_name))&&(!b[ii].class_name||reformator.dom_element.has_class(this.ancestors[iv],b[ii].class_name))){iii++;break}else if(b[ii-1].next_ancestor_must_be_parent){break}iv++}}if(iii==b.length){break}else{c=null}}}return c},match_with_ancestors:function(d){var t=this;var e=d.selector.elements;for(var i=0,j=0,jj=1,ancestor,tag;i<this.ancestors.length&&j<e.length;i++){ancestor=this.ancestors[i];tag=reformator.html.tags.all[ancestor.tagName];if(tag){if(eq(ancestor,e[j],tag)){j++}if(eq(ancestor,e[jj],tag)){jj++}if(e[j]&&e[j].valid&&!e[j].valid(t)){j=0;jj=1}}}return{disabled:e.length!=j&&e.length!=jj,active:e.length==j};function eq(a,b,c){return b&&(!b.tag_name||c.name.match(b.tag_name_pattern))&&(!b.class_name||reformator.dom_element.has_class(a,b.class_name))&&(!b.attributes||a.getAttribute(b.attributes[0].name))}},_format_table:function(a){if(a.tag_name=='table'){var b=this._format_block({tag_name:'div'});if(b&&b.length){var c=this.document.createElement('table');c.appendChild(this.document.createElement('caption'));var d=this.document.createElement('tbody');c.appendChild(d);b[0].parentNode.insertBefore(c,b[0]);for(var i=0,tr,td;i<b.length;i++){tr=this.document.createElement('tr');td=this.document.createElement('td');tr.appendChild(td);td.appendChild(b[i]);reformator.dom_element.replace_by_null(b[i]);d.appendChild(tr)}if(!c.nextSibling){c.parentNode.appendChild(this.document.createElement('br'))}return[c]}}else if(reformator.dom_table.prototype[a.tag_name]){var c=new reformator.dom_table({element:this.ancestors[0],document:this.document,selection:this.selection});if(c.cells&&c[a.tag_name]){c[a.tag_name]();this._format_clear_child(c.current.element)}}},_format_block:function(b){var c=reformator.dom_element.get_common_sibling_nodes(this.selection.get_start_node(),this.selection.get_end_node());if(c){var d=reformator.html.tags.all[b.tag_name];if(d.inline_only){for(var i=0,selected_tag;i<c.length;i++){if(c[i].tagName){selected_tag=reformator.html.tags.all[c[i].tagName];if(selected_tag&&selected_tag.block&&!selected_tag.inline){return null}}}}var f=c[0],parent_first_selected_node=f.parentNode;if(f.id.indexOf('reformator_selection_')>-1&&parent_first_selected_node&&parent_first_selected_node.tagName&&reformator.html.tags.all[parent_first_selected_node.tagName]&&reformator.html.tags.all[parent_first_selected_node.tagName].children){f=f.parentNode}while(f.tagName&&reformator.html.tags.all[f.tagName]&&reformator.html.tags.all[f.tagName].parents){f=f.parentNode;c=[f]}var g=reformator.html.tags.all[c[0].parentNode.tagName];while(c[0].parentNode&&c[0].parentNode==c[c.length-1].parentNode&&c[0].parentNode.tagName&&(g=reformator.html.tags.all[c[0].parentNode.tagName])&&(!g.block||(g.inline_only&&!d.inline_only))){c=[c[0].parentNode]}var h=c[0];c.reverse();function add_inline_sibling(a){var i=0;while(h&&(!h.tagName||!reformator.html.tags.all[h.tagName]||reformator.html.tags.all[h.tagName].inline)){if(i){c[c.length]=h}h=h[a+'Sibling'];i++}};add_inline_sibling('previous');c.reverse();h=c[c.length-1];add_inline_sibling('next');var j=this.document.createElement(window.addEventListener?b.tag_name:'<'+b.tag_name+'>');c[0].parentNode.insertBefore(j,c[0]);try{for(var i=0;i<c.length;i++){j.appendChild(c[i])}}catch(e){};g=reformator.html.tags.all[j.parentNode.tagName];if(g&&g.inline_only){this._replace_element_by_null(j.parentNode)}return[j]}else{return null}},_format_inline:function(e){if(this.selection.collapsed()&&e.tag_name&&reformator.html.tags.all[e.tag_name]&&reformator.html.tags.all[e.tag_name].empty){this.insert('<'+e.tag_name+' id="reformator_temp"/>');var f=this.document.getElementById('reformator_temp');if(f){f.id=''}return[f]}this.document.execCommand('fontname',null,'reformator_temp');var g=get_temp_elements(this.document.body);if(g&&g.length){var h=[];for(var i=0,element,new_element,tag;i<g.length;i++){element=g[i];h[h.length]=new_element=this.document.createElement(e.tag_name?e.tag_name:'span');tag=reformator.html.tags.all[element.tagName];if(tag&&tag.name!='span'&&tag.name!='font'&&tag.name!=e.tag_name&&element.id.indexOf('reformator_selection_')!=0){element.style.fontFamily='';if(tag.empty){element.parentNode.insertBefore(new_element,element);new_element.appendChild(element)}else{reformator.dom_element.move_children(element,new_element);element.appendChild(new_element)}}else if(element.parentNode&&element.id.indexOf('reformator_selection_')!=0){reformator.dom_element.replace_by(element,new_element)}}this._format_join_equal_sibling(h,e);this._format_join_equal_sibling(h,e);if(h[0]){this.selection.select_node(h[0])}return h}else{return null}function get_temp_elements(a){for(var i=0,child_node;i<a.childNodes.length;i++){child_node=a.childNodes[i];if(child_node&&child_node.nodeType==1){if(child_node.style.fontFamily=='reformator_temp'||child_node.face=='reformator_temp'){if(!b){var b=[]}b[b.length]=child_node}else{var c=get_temp_elements(child_node);if(c){if(b){for(var d=0;d<c.length;d++){b[b.length]=c[d]}}else{b=c}}}}}return b}},_format_join_equal_sibling:function(c,d){for(var i=0,ii=c.length,element,parent_element,parent_tag,sibling;i<ii;i++){element=c[i];parent_element=element.parentNode;if(parent_element){parent_tag=reformator.html.tags.all[parent_element.tagName];if(parent_tag&&!parent_tag.block&&ii>1&&reformator.html.remove_tags(parent_element.innerHTML)==reformator.html.remove_tags(element.innerHTML)){parent_element.parentNode.insertBefore(element,parent_element);reformator.dom_element.move_children(element,parent_element);element.appendChild(parent_element)}}if(element){sibling=element.previousSibling;while(sibling&&((!sibling.tagName&&!sibling.nodeValue)||(sibling.id&&sibling.id.indexOf('reformator_selection_')==0))){sibling=sibling.previousSibling}if(sibling&&sibling.nodeType==1){if(this._format_match_params(sibling,d)){reformator.dom_element.move_children_before(sibling,element.firstChild);sibling.parentNode.removeChild(sibling)}else{if(recursive_replace_element_by_null(sibling,d)){element.insertBefore(sibling,element.firstChild)}}}sibling=element.nextSibling;while(sibling&&((!sibling.tagName&&!sibling.nodeValue)||(sibling.id&&sibling.id.indexOf('reformator_selection_')==0))){sibling=sibling.nextSibling}if(sibling&&sibling.nodeType==1){if(this._format_match_params(sibling,d)){reformator.dom_element.move_children(sibling,element);sibling.parentNode.removeChild(sibling)}else{if(recursive_replace_element_by_null(sibling,d)){element.appendChild(sibling)}}}}}var t=this;function recursive_replace_element_by_null(a,b){for(var i=0,child_node,removed=false;i<a.childNodes.length;i++){child_node=a.childNodes[i];if(child_node&&child_node.nodeType==1){if(recursive_replace_element_by_null(child_node,b)){removed=true}if(t&&t._format_match_params(child_node,b)){t._replace_element_by_null(child_node);removed=true}}}return removed}},_format_match_params:function(a,b){return a.tagName.toLowerCase()==b.tag_name&&(!b.class_name||reformator.dom_element.has_class(a,b.class_name))},_format_apply_params:function(a,b){if(b.class_name){if(reformator.dom_element.has_class(a,b.class_name)){reformator.dom_element.remove_class(a,b.class_name)}else{reformator.dom_element.add_class(a,b.class_name)}}else{a.className=''}if(b.attributes){if(!b.attributes.length||!b.attributes.sort){b.attributes=[b.attributes]}for(var i=0;i<b.attributes.length;i++){a.setAttribute(b.attributes[i].name,b.attributes[i].value)}}},_format_clear:function(){this._format_clear_child(this.document.body);if(!this.document.body.childNodes.length){this.set_empty();this.set_edited(true)}},_format_clear_child:function(a,b){var c;tag=reformator.html.tags.all[a.tagName];if(tag&&tag.block){while(a.childNodes.length>1&&(c=a.childNodes[a.childNodes.length-1])&&((c.nodeType==3&&c.nodeValue.match(/^\s*$/))||(c.nodeType==1&&c.tagName.toLowerCase()=='br'&&!tag.can_be_empty))){c.parentNode.removeChild(c);this.set_edited(true)}}var d=a.childNodes,child_node,removed,tag,result={},class_name,class_names,o,attributes;for(var i=0,ii,inner_result,tags=0;i<d.length;i++){child_node=d[i];removed=false;if(child_node.nodeType==1){tags++;tag=reformator.html.tags.all[child_node.tagName];if(tag&&tag.remove_with_content&&!reformator.elements_by_tag_name[tag.name]){child_node.parentNode.removeChild(child_node);removed=true;i--;tags--;this.set_edited(true)}else{inner_result=this._format_clear_child(child_node);if(inner_result.block){result.block=true;if(tag&&tag.inline_only){this._replace_element_by_null(child_node);removed=true;i--;tags--;this.set_edited(true)}}if(!tag||(tag.remove&&!reformator.elements_by_tag_name[tag.name])){this._replace_element_by_null(child_node,tag?tag.inline_only:null);removed=true;i--;tags--;this.set_edited(true)}else if(inner_result.empty&&!tag.empty&&!tag.can_be_empty&&!reformator.dom_element.has_class(child_node,'nbsp')){this._replace_element_by_null(child_node);removed=true;i--;tags--;this.set_edited(true)}else if(tag.block&&!tag.inline){if(this.inline_only||b){child_node.appendChild(this.document.createTextNode(' '));this._replace_element_by_null(child_node);removed=true;i--;tags--;this.set_edited(true)}else{result.block=true}}else if(inner_result.block){this._replace_element_by_null(child_node);removed=true;i--;tags--;this.set_edited(true)}if(!removed){if(child_node.className){class_names=child_node.className.split(/\s+/);class_name='';for(ii=0;ii<class_names.length;ii++){o=reformator.elements_by_class_name[class_names[ii]];if(o&&(!o.tag_name||o.tag_name==tag.name)){class_name+=(class_name?' ':'')+class_names[ii]}}if(child_node.className!=class_name){child_node.className=class_name;this.set_edited(true)}}if(!child_node.className&&tag.remove_without_class){this._replace_element_by_null(child_node);removed=true;i--;tags--;this.set_edited(true)}}if(!removed){if(tag.replace_with&&!reformator.elements_by_tag_name[tag.name]){this._replace_element_by_new(child_node,tag.replace_with);this.set_edited(true)}else{child_node.style.cssText='';attributes=child_node.attributes;for(ii=0;ii<attributes.length;ii++){if(!tag.attributes[attributes[ii].nodeName.toLowerCase()]&&attributes[ii].nodeValue&&attributes[ii].nodeValue.indexOf('reformator_')<0){child_node.removeAttributeNode(attributes[ii]);this.set_edited(true)}}}}}}else{if(child_node.nodeValue&&child_node.nodeValue.match(this.nbsp_patterns)){child_node.nodeValue=child_node.nodeValue.replace(this.nbsp_patterns,reformator.html.entities.common.nbsp[0])}}}if(!d.length||(!tags&&a.innerHTML.match(this.empty_pattern))){result.empty=true}return result},_cancel_submit:function(b){for(var i=0;i<b.length;i++){reformator.dom_element.add_event_listener(b[i],'submit',function(a){return reformator.dom_element.cancel_event(a)})}},_replace_element_by_null:function(a){var b=reformator.html.tags.all[a.tagName];if(b&&b.children){for(var i=a.childNodes.length-1,child_node,child_tag;i>=0;i--){child_node=a.childNodes[i];if(child_node.tagName){child_tag=reformator.html.tags.all[child_node.tagName];if(child_tag&&b.children[child_tag.name]){this._replace_element_by_null(child_node)}}}}if(b&&(b.name=='caption'||b.name=='tr')&&a.innerHTML){var c=this.document.createElement('div');reformator.dom_element.replace_by(a,c)}else if(b&&(b.name=='td'||b.name=='th')){if(a.nextSibling){a.parentNode.insertBefore(this.document.createTextNode(' '),a.nextSibling)}reformator.dom_element.replace_by_null(a)}else{reformator.dom_element.replace_by_null(a)}},_replace_element_by_new:function(a,b,c){var d=reformator.html.tags.all[a.tagName],new_tag=reformator.html.tags.all[b],new_element=this.document.createElement(b),attribute_value;for(var s in new_tag.attributes){if(new_tag.attributes.constructor.prototype[s])continue;attribute_value=a.getAttribute(s);if(attribute_value){new_element.setAttribute(s,attribute_value)}}new_element.className=a.className;if(c){reformator.dom_element.add_class(new_element,c)}reformator.dom_element.replace_by(a,new_element);return new_element},set_empty:function(){try{if(!this.inline_only){this.document.body.innerHTML='<p><br/></p>';this.selection.select_node(this.document.body.firstChild.firstChild)}else{this.document.body.innerHTML=' <br/>'}}catch(e){}},set_edited:function(a){this.edited=a;if(a){this.editor.on_wysiwyg_change()}},store_selection:function(){return this.selection.store()},restore_selection:function(a){this.selection.restore(a);this._update_selection()},_update_selection:function(){this.parent_element=this.selection.get_parent_element();this.ancestors=reformator.dom_element.get_ancestors_elements(this.parent_element,true);this.ancestors_path='';for(var i=this.ancestors.length-1;i>=0;i--){this.ancestors_path+=this.ancestors[i].tagName+(this.ancestors[i].className?'.'+this.ancestors[i].className.replace(/\s+/g,'.'):'')+(i?' > ':'')}window.status=this.ancestors_path;reformator.control.refresh()}};reformator.wysiwyg_undo=function(a){this.wysiwyg=a;this.selection=a.selection;this.window=a.window;this.document=this.window.document;try{var b=this.document.body.innerHTML;this.states=[{content:b,normalized_content:b},{content:b,normalized_content:b}];this.position=0}catch(e){var b='';this.states=[];this.position=-1};this.clear_as()};reformator.wysiwyg_undo.prototype={backward:function(){if(this.position>0){this.position-=2;this.restore(true)}},forward:function(){if(this.states[this.position+2]){this.position+=2;this.restore()}},store:function(a){var b=this.position;if(!a){a={}}var c=this.selection.store();var d=this.document.body.innerHTML;var e=d.replace(/<([A-Za-z]+)[^>]+reformator_selection_[01][^>]*>(<\/\1>)?/g,'');if(this.position<0){this.position=0;this.states[this.position]={selection:c,content:d};this.states[this.position+1]={selection:c,content:d,normalized_content:e}}else{var b=this.position;if(!a.as_selection){if(a.as_remove){if(!this.as_remove){this.as_sequence=false;this.as_remove=true}}else if(this.as_remove){this.clear_as()}if(a.as_sequence){if(!this.as_sequence){this.position+=2}this.as_sequence=true}else{this.position+=2;this.clear_as()}if(b!=this.position&&this.states[this.position-2].normalized_content==e){this.clear_as();this.position-=2}else{this.states[this.position]={selection:c,content:d,normalized_content:e};this.states[this.position+2]=null;this.states[this.position+3]=null}}else{this.clear_as()}this.states[this.position+1]={selection:c,content:d,normalized_content:e}}},restore:function(a){var b=a?1:0;this.document.body.innerHTML=this.states[this.position+b].content;this.selection.restore(this.states[this.position+b].selection);this.clear_as()},clear_as:function(){this.as_sequence=false;this.as_remove=false}};reformator.bar={create:function(){reformator.dom_element.add_class(document.body.parentNode,'with_reformator_bar');this.created=true;this.element=document.createElement('div');this.element.id='reformator_bar';this.element.innerHTML='<iframe frameborder="no"></iframe>';var t=this;setTimeout(function(){document.body.appendChild(t.element);t.element.firstChild.src=reformator.bar_path;if(!document.cookie||document.cookie.indexOf('reformator_bar=hidden')<0){t.set_active(true)}},0)},set_active:function(a){this.actived=a;if(!this.actived){document.cookie='reformator_bar=hidden'}else{document.cookie='reformator_bar=visible'}reformator.dom_element.replace_class(document.body.parentNode,'reformator_bar_visible','',this.actived);document.body.className+=''}};reformator.control={auto:function(a){this.init(a);var b=this.element.getElementsByTagName('a');for(var i=0,command;i<b.length;i++){command=unescape(b[i].getAttribute('href')).match(/^[^#]*#([^\s]+)\s*(.*)?/);if(command){this.append({element:b[i],action:command[1],option:command[2]})}}},init:function(a){this.element=a&&a.element?a.element:document.body},children:[],append:function(a){this.children[this.children.length]=new reformator.control.object(a)},refresh:function(){var t=this;if(!reformator.current||!reformator.current.focused){for(var i=0;i<t.children.length;i++){t.children[i].set_disabled(true)}}else{for(var i=0;i<t.children.length;i++){t.children[i].set_disabled(false);t.children[i].update()}}}};reformator.control.object=function(b){this.element=b.element;this.cancel_event(this.element.parentNode);if(b.action&&reformator.control.actions[b.action]){for(var s in reformator.control.actions[b.action]){if(reformator.control.actions[b.action].constructor.prototype[s])continue;this[s]=reformator.control.actions[b.action][s]}this.init(b.option);var t=this;reformator.dom_element.add_event_listener(this.element,'mousedown',function(a){if(t.disabled){return reformator.dom_element.cancel_event(a)}else{t.clicked=true}});reformator.dom_element.add_event_listener(this.element,'click',function(a){if(!t.disabled||t.clicked){t.exec();if(reformator.current){reformator.current.focus()}t.update()}t.clicked=false;reformator.control.refresh();return reformator.dom_element.cancel_event(a)})}this.set_disabled(true)};reformator.control.object.prototype={set_disabled:function(a){this.disabled=a&&!this.clicked;reformator.dom_element.replace_class(this.element.parentNode,'disabled','',this.disabled);this.set_active(!this.disabled)},set_active:function(a){this.actived=a;reformator.dom_element.replace_class(this.element,'active','',this.actived)},update:function(){this.set_disabled(false)},init:function(a){},exec:function(){},cancel_event:function(b){if(b&&b.unselectable!='on'&&b!=this.element){b.unselectable='on';reformator.dom_element.add_event_listener(b,'mousedown',function(a){reformator.dom_element.cancel_event(a)});if(b!=reformator.control.element){this.cancel_event(b.parentNode)}}}};reformator.control.actions={source:{exec:function(){reformator.current.set_active(!reformator.current.actived)},update:function(){this.set_active(!reformator.current.actived)}},bar:{init:function(){this.update()},exec:function(){reformator.bar.set_active(!reformator.bar.actived)},update:function(){this.set_active(reformator.bar.actived)},set_disabled:function(a){}},maximize:{exec:function(){reformator.current.set_maximize(!reformator.current.maximize)},update:function(){this.set_active(reformator.current.maximize)}},autoformat:{exec:function(){reformator.current.set_autoformat(!reformator.current.autoformat)},update:function(){this.set_active(reformator.current.autoformat)}},typograph:{exec:function(){reformator.current.typograph()},set_active:function(a){}},autoclear:{exec:function(){reformator.current.set_autoclear(!reformator.current.autoclear)},update:function(){this.set_active(reformator.current.autoclear)}},clear:{exec:function(){reformator.current.clear()},set_active:function(a){}},undo:{set_active:function(a){},update:function(){this.set_disabled(!reformator.current.actived||reformator.current.wysiwyg.undo.position<=0)},exec:function(){reformator.current.wysiwyg.undo.backward()}},redo:{set_active:function(a){},update:function(){this.set_disabled(!reformator.current.actived||!reformator.current.wysiwyg.undo.states[reformator.current.wysiwyg.undo.position+2])},exec:function(){reformator.current.wysiwyg.undo.forward()}},insert:{init:function(c){if(this.element.onclick){this.func=this.element.onclick;if(!c){this.block=true}this.element.onclick=null}if(c){var t=this;c.replace(/<(\w+)[^<>]*>/g,function(a,b){if(reformator.html.tags.all[b]&&reformator.html.tags.all[b].block&&!reformator.html.tags.all[b].inline){t.block=true}});this.html=c}},update:function(){if(!reformator.current.actived){this.set_disabled(true)}else{if(reformator.current.inline_only&&this.block){this.set_disabled(true)}else{this.set_disabled(false)}}},exec:function(){if(this.func){var a=this.func();if(a){if(typeof(a)=='object'){reformator.current.wysiwyg.insert(a[0],a[1],a[2],this.block)}else{reformator.current.wysiwyg.insert(a,null,null,this.block)}}}else if(this.html){reformator.current.wysiwyg.insert(this.html,null,null,this.block)}},set_active:function(a){}},format:{init:function(a){this.selector=reformator.css.parse_selector(a)},update:function(){if(!reformator.current.actived){this.set_disabled(true)}else{var a=reformator.current.wysiwyg.match_with_ancestors({selector:this.selector});if(reformator.current.inline_only&&this.selector.block){this.set_disabled(true)}else{this.set_disabled(a.disabled)}this.set_active(a.active&&(reformator.current.wysiwyg.selection.collapsed()||reformator.current.wysiwyg.selection.get_type()=='element'))}},exec:function(){if(this.selector.attributes){this.exec_with_prompt_attribute(this.selector.attributes[0].name)}else if(this.selector.tag_name=='a'){this.exec_with_prompt_attribute('href')}else if(this.selector.tag_name=='img'){this.exec_with_prompt_attribute('src')}else{reformator.current.wysiwyg.format({selector:this.selector})}},exec_with_prompt_attribute:function(a){var b=reformator.current.wysiwyg.find_suitable_ancestor_element({selector:this.selector}),attribute_value=b?b.getAttribute(a):'';if(this.selector.class_name&&b){reformator.current.wysiwyg.format({selector:this.selector,remove:false})}else{attribute_value=prompt(this.element.title,attribute_value);if(attribute_value!=null){if((a=='href'||a=='src')&&attribute_value&&!attribute_value.match(/^([a-z]+\:|\/)/)){attribute_value=(attribute_value.match(/^(?:[-a-z\d\+\*\/\?!{}`~_%&'=^$#]+(?:\.[-a-z\d\+\*\/\?!{}`~_%&'=^$#]+)*)@(?:[-a-z\d_]+\.){1,60}[a-z]{2,6}$/)?'mailto:':'http://')+attribute_value}if(!(!attribute_value&&!b)){reformator.current.wysiwyg.format({selector:this.selector,attributes:[{name:a,value:attribute_value}],remove:!attribute_value})}}}}}};reformator.css={parse_selector:function(a){return this.children[a]?this.children[a]:this.children[a]=new this.selector(a)},children:[],selector:function(j){this.elements=[];var t=this,i;if(j){j=j.replace(/list\s+indent/,'li li');j=j.replace(/(^\s+|\s+$)/g,'');j=j.replace(/(\s*\>\s*|\s*\+\s*|\s+)?([a-zA-Z0-9\.\#\-\_\:\[\]\=\~\"\'\|\*]+)/g,function(s,g,h){if(h){i=t.elements.length;element={};if(g&&g.indexOf('>')>-1){element.next_ancestor_must_be_parent=true}else if(g&&g.indexOf('+')>-1){element.immediately_preceding=t.elements[i-1];i--}else if(g&&g.indexOf('~')>-1){element.preceding=t.elements[i-1];i--}h=h.replace(/\[([^\]]*)\]/g,function(s,e){if(e){if(!element.attributes){element.attributes=[]}var f=e.replace(/^([a-zA-Z0-9]+)(?:(.?=)"([^"]*)")?$/,function(a,b,c,d){element.attributes[element.attributes.length]={name:b,expression:c,value:d};return''})}return''});h=h.replace(/([\.\#\:])([^\.\#\:]+)/g,function(s,a,b){if(a=='.'){element.class_name=b}else if(a=='#'){element.id=b}return''});if(h!='*'){element.tag_name=h}else{h='.'+h}if(h){element.tag_name_pattern=new RegExp('^'+h+'$')}t.elements[i]=element}return''})}if(this.elements.length){this.elements.reverse();this.tag_name=this.elements[0].tag_name;this.class_name=this.elements[0].class_name;this.attributes=this.elements[0].attributes;this.id=this.elements[0].id;if(this.class_name){reformator.elements_by_class_name[this.class_name]={tag_name:this.tag_name}}if(this.tag_name){var k=reformator.html.tags.all[this.tag_name];if(k){this.block=k.block}if(this.elements[0].tag_name=='li'&&this.elements[1].tag_name=='li'){this.elements[0].tag_name_pattern=/^$/;this.elements[1].tag_name_pattern=/^[uo]l$/}else{reformator.elements_by_tag_name[this.tag_name]={class_name:this.class_name}}}}}};reformator.dom_table=function(a){if(a.element){this.find_cell_and_table(a.element)}this.document=a.document?a.document:document;this.selection=a.selection;if(this.table){this.init()}};reformator.dom_table.prototype={append_row_before:function(){var a=this.document.createElement('tr');for(var i=0,cell,new_cell;i<this.cells[this.current.row].length;i++){cell=this.cells[this.current.row][i];if(cell.col==i){if(cell.row==this.current.row){new_cell=this.document.createElement(cell.element.tagName);new_cell.appendChild(this.document.createElement('br'));if(cell.element.colSpan>1){new_cell.colSpan=cell.element.colSpan}a.appendChild(new_cell)}else{cell.element.rowSpan++}}}this.rows[this.current.row].parentNode.insertBefore(a,this.rows[this.current.row])},append_row_after:function(){var a=this.document.createElement('tr'),current_row=this.current.row+this.current.element.rowSpan-1;for(var i=0,cell,new_cell;i<this.cells[current_row].length;i++){cell=this.cells[current_row][i];if(cell.col==i){if(cell.row==current_row&&cell.element.rowSpan>1){cell.element.rowSpan++}else{new_cell=this.document.createElement(cell.element.tagName);new_cell.appendChild(this.document.createElement('br'));if(cell.element.colSpan>1){new_cell.colSpan=cell.element.colSpan}a.appendChild(new_cell)}}}i=current_row+1;if(this.rows[i]){this.rows[i].parentNode.insertBefore(a,this.rows[i])}else{this.rows[current_row].parentNode.appendChild(a)}},append_column_before:function(){var i=0,cell,new_cell;while(this.cells[i]){cell=this.cells[i][this.current.col];if(cell.col==this.current.col){new_cell=this.document.createElement(cell.element.tagName);new_cell.rowSpan=cell.element.rowSpan;new_cell.appendChild(this.document.createElement('br'));cell.element.parentNode.insertBefore(new_cell,cell.element)}else{cell.element.colSpan++}i+=cell.element.rowSpan}},append_column_after:function(){var a=this.current.col+this.current.element.colSpan-1,i=0,cell,new_cell,bottom;while(this.cells[i]){cell=this.cells[i][a];if(cell.col+cell.element.colSpan-1>a){cell.element.colSpan++}else{new_cell=this.document.createElement(cell.element.tagName);new_cell.rowSpan=cell.element.rowSpan;new_cell.appendChild(this.document.createElement('br'));next=this.find_right_cell(i,a);if(next){next.parentNode.insertBefore(new_cell,next)}else{this.rows[i].appendChild(new_cell)}}i+=cell.element.rowSpan}},join_right:function(){var i=this.current.col+1;while(this.cells[this.current.row][i]&&this.cells[this.current.row][i].col==this.current.col){i++}var a=this.cells[this.current.row][i];if(a&&this.current.col!=a.col&&this.current.row==a.row&&this.current.element.rowSpan==a.element.rowSpan){this.current.element.appendChild(this.document.createTextNode(' '));reformator.dom_element.move_children(a.element,this.current.element);this.current.element.colSpan+=a.element.colSpan;a.element.parentNode.removeChild(a.element)}},join_bottom:function(){var i=this.current.row+1;while(this.cells[i]&&this.cells[i][this.current.col].row==this.current.row){i++}var a=this.cells[i]?this.cells[i][this.current.col]:null;if(a&&this.current.row!=a.row&&this.current.col==a.col&&this.current.element.colSpan==a.element.colSpan){this.current.element.appendChild(this.document.createTextNode(' '));reformator.dom_element.move_children(a.element,this.current.element);this.current.element.rowSpan+=a.element.rowSpan;a.element.parentNode.removeChild(a.element)}},split:function(){if(this.current.element.colSpan>1||this.current.element.rowSpan>1){for(var i=0,ii,next,new_cell;i<this.current.element.rowSpan;i++){if(this.rows[this.current.row+i]){for(ii=!i?1:0;ii<this.current.element.colSpan;ii++){new_cell=this.document.createElement(this.current.element.tagName);new_cell.appendChild(this.document.createElement('br'));next=this.find_bottom_cell(this.current.row+i,this.current.col);if(next){next.parentNode.insertBefore(new_cell,next)}else{this.rows[this.current.row+i].appendChild(new_cell)}}}}this.current.element.colSpan=1;this.current.element.rowSpan=1}},remove_row:function(){var i=0,cell,bottom;while(this.cells[this.current.row][i]){cell=this.cells[this.current.row][i];if(!cell.removed){if(cell.element.rowSpan>1){if(cell.row==this.current.row){if(this.rows[this.current.row+1]){bottom=this.find_bottom_cell(this.current.row+1,i);if(bottom){bottom.parentNode.insertBefore(cell.element,bottom)}else{this.rows[this.current.row+1].appendChild(cell.element)}}while(cell.element.childNodes[0]){cell.element.removeChild(cell.element.childNodes[0])}cell.element.appendChild(this.document.createElement('br'))}if(cell.element.rowSpan>1){cell.element.rowSpan--}}else{cell.element.parentNode.removeChild(cell.element)}cell.removed=true}i++}this.rows[this.current.row].parentNode.removeChild(this.rows[this.current.row]);var a=this.cells[this.current.row+1];if(!a){a=this.cells[this.current.row-1]}if(a){this.selection.select_node(a[this.current.col].element);this.selection.collapse(true)}},remove_column:function(){var i=0,cell,removed;while(this.cells[i]){cell=this.cells[i][this.current.col];if(!cell.removed){if(cell.element.colSpan>1){if(cell.col==this.current.col){while(cell.element.childNodes[0]){cell.element.removeChild(cell.element.childNodes[0]);removed=true}cell.element.appendChild(this.document.createElement('br'))}if(cell.element.colSpan>1){cell.element.colSpan--}}else{cell.element.parentNode.removeChild(cell.element);removed=true}cell.removed=true}i++}if(removed){var a=this.cells[this.current.row][this.current.col+1];if(!a){a=this.cells[this.current.row][this.current.col-1]}if(a){this.selection.select_node(a.element.firstChild);this.selection.collapse(true)}}},find_right_cell:function(a,b){var c=this.cells[a],i=b;while(c[i]&&(c[i].col<=b||c[i].row!=a)){i++}return c[i]&&c[i].col>b&&c[i].row==a?c[i].element:null},find_bottom_cell:function(a,b){var c=this.cells[a],i=b;while(c[i]&&(c[i].col==b||c[i].row!=a)){i++}return c[i]&&c[i].col!=b&&c[i].row==a?c[i].element:null},init:function(){this.row_index=-1;this.col_index=-1;this.cells=[];this.rows=[];this.init_by_parent(this.table)},init_by_parent:function(a){for(var i=0,ii,iii,cell,child_node,tag;i<a.childNodes.length;i++){child_node=a.childNodes[i];if(child_node.tagName){tag=reformator.html.tags.all[child_node.tagName];if(tag.name=='td'||tag.name=='th'){if(this.col_index<0){this.row_index++;this.rows[this.row_index]=child_node.parentNode}this.col_index++;if(!this.cells[this.row_index]){this.cells[this.row_index]=[]}while(this.cells[this.row_index][this.col_index]){this.col_index++}cell={element:child_node,col:this.col_index,row:this.row_index};if(child_node==this.cell){cell.current=true;this.current=cell}for(ii=0;ii<child_node.colSpan;ii++){this.cells[this.row_index][this.col_index+ii]=cell;for(iii=1;iii<child_node.rowSpan;iii++){if(!this.cells[this.row_index+iii]){this.cells[this.row_index+iii]=[]}this.cells[this.row_index+iii][this.col_index+ii]=cell}}this.col_index+=child_node.colSpan-1}else{if(tag.name=='tr'){this.col_index=-1}this.init_by_parent(child_node)}}}},find_cell_and_table:function(a){while(a&&a.tagName&&!this.cell){if(a.tagName.toLowerCase().match(/^t[dh]$/)){this.cell=a;break}a=a.parentNode}while(a&&a.tagName&&!this.table){if(a.tagName.toLowerCase()=='table'){this.table=a}a=a.parentNode}}};reformator.dom_element={patterns:[],init:function(){this.root_path=top.location.href.replace(/^\w+:\/+[^\/]*\//,'').replace(/\/[^\/]*$/,'');this.root_path=this.root_path.split('/')},replace_class:function(a,b,c,d){if(!d){this.remove_class(a,b);this.add_class(a,c)}else{this.remove_class(a,c);this.add_class(a,b)}},add_class:function(a,b){if(b&&!this.has_class(a,b)){a.className+=(a.className?' ':'')+b}},remove_class:function(a,b){if(b){var c='remove+'+b;if(!this.patterns[c]){this.patterns[c]=new RegExp('(.*)(^|\\s+)('+b+')($|\\s+)(.*)')}if(this.has_class(a,b)){a.className=a.className.replace(this.patterns[c],'$1$4$5').replace(/^\s/,'')}}},has_class:function(a,b){var c=' '+a.className.replace(/[\t\n]+/g,' ')+' ';return c.match(' '+b+' ')?true:false},get_style:function(f,g,h){var i=g.indexOf('-');if(f.runtimeStyle&&i>-1){g=g.substr(0,i)+g.substr(i+1,1).toUpperCase()+g.substr(i+2)}var j='';if(!h){h=document}if(f.runtimeStyle){j=f.currentStyle[g]}else if(h.defaultView&&h.defaultView.getComputedStyle){j=h.defaultView.getComputedStyle(f,null).getPropertyValue(g)}else if(f.style){j=f.style[g]}if(j&&j.match(/rgb/)){j=j.replace(/rgb\s*\(\s*(\d+)\s*,\s*(\d+)\s*,\s*(\d+)\s*\)/ig,function(b,c,d,e){var a=[(new Number(c)).toString(16),(new Number(d)).toString(16),(new Number(e)).toString(16)];return'#'+(a[0].length<2?'0'+a[0]:a[0])+(a[1].length<2?'0'+a[1]:a[1])+(a[2].length<2?'0'+a[2]:a[2])})}return j},set_style:function(a,b){if(typeof(a.style.cssText)!='undefined'){a.style.cssText=b}else{a.setAttribute('style',b)}},get_inner_html:function(a,b,c){if(b==undefined||c){b=''}var d,html='',tag,inner_html,attributes_html;for(var i=0;i<a.childNodes.length;i++){d=a.childNodes[i];if(d.nodeType==1){tag=reformator.html.tags.all[d.tagName];if(!c&&html){html=html.replace(/\n\s+$/,'\n')}if(!tag){html+=this.get_inner_html(d,b,c)}else if(d.id.indexOf('reformator_selection_')!=0){inner_html=this.get_inner_html(d,b+(tag.block?'\t':''),c||tag.preformatted);attributes_html=this.get_attributes_html(d);if(inner_html||tag.can_be_empty){if(!c){if(tag.block&&(!html||!html.match(/\n\s*$/))){html+='\n'}if(html&&html.match(/\n\s*$/)){html+=b}}html+='<'+tag.name+attributes_html+'>'+inner_html;if(!c){if(tag.block&&inner_html&&inner_html.match(/\n/)&&!inner_html.match(/\n\s*$/)){html+='\n'}if(html&&html.match(/\n\s*$/)){html+=b}}html+='</'+tag.name+'>';if(!c&&tag.block){html+='\n'}}else if(tag.empty){if(!c&&html&&html.match(/\n\s*$/)){html+=b}if(tag.name!='br'||!c){if(tag.name=='img'){if(attributes_html.indexOf('width="')<0){attributes_html+=' width="'+d.offsetWidth+'"'}if(attributes_html.indexOf('height="')<0){attributes_html+=' height="'+d.offsetHeight+'"'}}html+='<'+tag.name+attributes_html+'/>'}if(tag.name=='br'){html+='\n'}}}}else if(d.nodeType==3&&d.nodeValue){var e=d.nodeValue.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');if(!c){e=e.replace(/[\s\n\r]+/g,' ')}html+=e}}return html},get_attributes_html:function(c){var d=reformator.html.tags.all[c.tagName].attributes,html='',value;for(var s in d){if(d.constructor.prototype[s])continue;value=c.getAttribute(s)+'';if(value&&s!='class'&&value!=d[s].null_value&&value!='null'){if(s=='href'||s=='src'||s=='action'){var t=this;value=value.replace(/^[^\/]+:\/\/\//,'/').replace(/^(?:\.\/)*((?:\.\.\/)*)/,function(a,b){if(b){var s='/',i,ii=t.root_path.length-b.length/3;for(var i=0;i<ii;i++){s+=t.root_path[i]+'/'}return s}else{return''}})}html+=' '+s+'="'+value.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/[\s\n\r]+/g,' ')+'"'}}if(c.className){html+=' class="'+c.className+'"'}return html},listeners:[],fire_event:function(a,b){if(!a.sort){a=[a]}if(!b.sort){b=[b]}for(var i=0,ii,event;i<a.length;i++){for(ii=0;ii<b.length;ii++){if(document.createEvent){if(b[ii].indexOf('key')==0){try{event=document.createEvent('KeyEvents')}catch(error){event=document.createEvent('Events')}event.initEvent(b[ii],true,true,document.defaultView,0,0,0,0,0)}else{event=document.createEvent('Events');event.initEvent(b[ii],true,true)}a[i].dispatchEvent(event)}else if(a[i].attachEvent&&a[i].fireEvent){a[i].fireEvent('on'+b[ii])}}}},add_event_listener:function(a,b,c){if(a.length&&a.sort){for(var i=0;i<a.length;i++){this.add_event_listener(a[i],b,c)}return}if(!b.match&&b.length){for(var i=0;i<b.length;i++){this.add_event_listener(a,b[i],c)}return}this.listeners[this.listeners.length]=[a,b,c];if(this.listeners.length==1){this.init_detach_listeners(window)}if(a.addEventListener){a.addEventListener(b,c,false)}else if(a.attachEvent){a.attachEvent('on'+b,c)}},remove_event_listener:function(a,b,c){if(a.length&&a.sort){for(var i=0;i<a.length;i++){this.remove_event_listener(a[i],b,c)}return}if(!b.match&&b.length){for(var i=0;i<b.length;i++){this.remove_event_listener(a,b[i],c)}return}if(a.removeEventListener){a.removeEventListener(b,c,false)}else if(a.detachEvent){a.detachEvent('on'+b,c)}},init_detach_listeners:function(a){this.add_event_listener(a,'unload',function(){reformator.dom_element.detach_listeners(a)})},detach_listeners:function(a){for(var i=0;i<this.listeners.length;i++){this.remove_event_listener(this.listeners[i][0],this.listeners[i][1],this.listeners[i][2]);this.listeners[i][0]=null}this.listeners.length=0;this.listeners=null;if(a.CollectGarbage){a.CollectGarbage()}},cancel_event:function(a){if(!a){a=window.event}a.cancelBubble=true;a.returnValue=false;if(a.cancelable){a.preventDefault();a.stopPropagation()}return false},normalize_event:function(a){if(!a){a=window.event}if(a){a.element=a.target?a.target:a.srcElement;a.key_code=a.keyCode?a.keyCode:(a.which?a.which:null)}else{a={}}return a},get_coords:function(a){if(!a){a=window.event}var b={left:0,top:0};if(a.pageX||a.pageY){b.left=a.pageX;b.top=a.pageY}else if(a.clientX||a.clientY){b.left=a.clientX+document.body.scrollLeft-document.body.clientLeft;b.top=a.clientY+document.body.scrollTop-document.body.clientTop;if(document.body.parentElement&&document.body.parentElement.clientLeft){var c=document.body.parentElement;b.left+=c.scrollLeft-c.clientLeft;b.top+=c.scrollTop-c.clientTop}}return b},replace_by:function(a,b){this.move_children(a,b);a.parentNode.insertBefore(b,a);a.parentNode.removeChild(a)},replace_by_null:function(a){if(a.parentNode){this.move_children_before(a,a);a.parentNode.removeChild(a)}},move_children_before:function(a,b){while(a.childNodes.length){b.parentNode.insertBefore(a.childNodes[0],b)}},move_children:function(a,b){while(a.childNodes.length){b.appendChild(a.childNodes[0])}},get_common_sibling_nodes:function(a,b){var c=this.get_ancestors_elements(a,true);var d=this.get_ancestors_elements(b,true);for(var i=0,common_sibling,current;i<c.length;i++){current=c[i];common_sibling=[];while(current){common_sibling[common_sibling.length]=current;if(current==d[i+d.length-c.length]){return common_sibling}current=current.nextSibling}}return null},get_ancestors_elements:function(a,b){var c=a.parentNode,ancestors=b?[a]:[];while(c&&c.tagName&&c.tagName.toLowerCase()!='body'&&c.tagName.toLowerCase()!='html'){ancestors[ancestors.length]=c;c=c.parentNode}return ancestors},get_first_ancestor_element:function(a,b){var c=a.parentNode;if(b){while(c.tagName&&c.tagName.toLowerCase()!='body'&&c.tagName.toLowerCase()!=b){c=c.parentNode}return c.tagName.toLowerCase()==b?c:null}return c},get_first_previous_sibling_element:function(a,b){var c=a;while(c&&c.previousSibling){c=c.previousSibling;if(c.tagName&&(!b||c.tagName.toLowerCase()==b)){return c}}return null},get_next_sibling_element:function(a,b){var c=a;while(c&&c.nextSibling){c=c.nextSibling;if(c.tagName&&(!b||c.tagName.toLowerCase()==b)){return c}}return null}};reformator.dom_selection=function(b){this.window=b;this.document=this.window.document;this.selection=this.get();this.on_change_functions=[];this.event={};var t=this;reformator.dom_element.add_event_listener(this.window.addEventListener?this.window:this.document,['keydown','keyup','mouseup',(this.window.addEventListener?'DOMAttrModified':'selectionchange')],function(a){a=reformator.dom_element.normalize_event(a);if(a.key_code){t.event.key_code=a.key_code;t.event.ctrlKey=a.ctrlKey;t.event.altKey=a.altKey;t.event.shiftKey=a.shiftKey;t.event.metaKey=a.metaKey}else if(t.event.pageX||t.event.pageY){t.left=t.event.pageX;t.top=t.event.pageY}else if(t.event.clientX||t.event.clientY){t.left=t.event.clientX+t.document.body.scrollLeft-t.document.body.clientLeft;t.top=t.event.clientY+t.document.body.scrollTop-t.document.body.clientTop}if(t.on_change_timeout){clearTimeout(t.on_change_timeout)}t.on_change_timeout=setTimeout(function(){t.on_change(t.event);t.event={}},200)})};reformator.dom_selection.prototype={add_on_change_function:function(f){this.on_change_functions[this.on_change_functions.length]=f},on_change:function(a){this.refresh();for(var i=0;i<this.on_change_functions.length;i++){this.on_change_functions[i](a)}},refresh:function(){this.selection=this.get();this.range=this.get_range()},get_type:function(){this.range=this.get_range();var a=this.collapsed();if(a){return'none'}else if((this.range.toString&&!this.range.toString())||this.selection.type=='Control'||(this.range.htmlText&&!this.range.htmlText.replace(/<\/?[a-z]+[^>]*>/ig,''))){return'element'}else{return'text'}},collapsed:function(){if(!this.range){this.range=this.get_range()}if(!this.range){return false}else{if(this.range.compareEndPoints){return this.range.compareEndPoints('StartToEnd',this.range)===0}else{return!this.selection||this.range.collapsed||this.range.boundingWidth==0}}},collapse:function(a){if(!this.range){this.range=this.get_range()}if(this.range.select){this.range.collapse(a);this.range.select()}else{if(a){this.range.setEnd(this.range.startContainer,this.range.startOffset)}else{this.range.setStart(this.range.endContainer,this.range.endOffset)}this.range.collapse(a);this.selection.removeAllRanges();this.selection.addRange(this.range)}},select_node:function(a){if(a){var b;if(!this.window.getSelection){b=this.document.body.createTextRange();try{b.moveToElementText(a);b.select(a);this.range=b}catch(error){}}else{if(this.selection){b=this.document.createRange();try{b.selectNode(a)}catch(error){b.selectNodeContents(a)};this.selection.removeAllRanges(b);this.selection.addRange(b);this.range=b}}this.refresh()}},get_inner_html:function(){this.range=this.get_range();if(this.range.cloneContents){this._init_document_fragment();this.document_fragment.appendChild(this.range.cloneContents());return this.document_fragment.innerHTML}else{return this.range.htmlText}},get_inner_text:function(){this.range=this.get_range();if(this.range.cloneContents){this._init_document_fragment();this.document_fragment.appendChild(this.range.cloneContents());return this.document_fragment.innerText||this.document_fragment.textContent||' '}else{return this.range.text}},_init_document_fragment:function(){if(!this.document_fragment){this.document_fragment=this.document.createElement('div')}this.document_fragment.innerHTML=''},get_start_node:function(){if(this.range.startContainer){return this.document.getElementById('reformator_selection_0')}else if(this.range.parentElement){var a=this.range.duplicate();a.collapse(true);var b=a.parentElement();for(var i=0,child_node,last_text_node=null;i<b.childNodes.length;i++){child_node=b.childNodes[i];if(child_node.nodeType==1){a.moveToElementText(child_node);if(this.range.compareEndPoints('StartToEnd',a)<0&&last_text_node){return last_text_node}last_text_node=null}else if(!last_text_node){last_text_node=child_node}}return last_text_node||b.firstChild||b}},get_end_node:function(){if(this.range.startContainer){return this.document.getElementById('reformator_selection_1')}else if(this.range.parentElement){var a=this.range.duplicate();a.collapse(false);var b=a.parentElement();for(var i=b.childNodes.length-1,child_node,last_text_node=null;i>=0;i--){child_node=b.childNodes[i];if(child_node.nodeType==1){a.moveToElementText(child_node);if(this.range.compareEndPoints('EndToEnd',a)>0&&last_text_node){return last_text_node}last_text_node=null}else if(!last_text_node){last_text_node=child_node}}return last_text_node||b.lastChild||b}},get_parent_element:function(){this.range=this.get_range();var a=null;if(!this.window.getSelection){if(this.selection.type=='Control'){a=this.range.item(0).parentNode}else{a=this.range.parentElement()}}else{a=this.range.commonAncestorContainer;while(a&&a.nodeType==3){a=a.parentNode}}return a},store:function(){var a=null;this.range=this.get_range();if(this.range&&this.range.getBookmark){a={string:this.range.getBookmark(),collapsed:this.collapsed()}}else if(this.range.cloneRange){for(var i=0,clone_range,id,selection_element;i<2;i++){id='reformator_selection_'+(1-i);clone_range=this.range.cloneRange();if(i==0){clone_range.setStart(clone_range.endContainer,clone_range.endOffset)}else{clone_range.setEnd(clone_range.startContainer,clone_range.startOffset)}selection_element=this.document.getElementById(id);if(!selection_element){selection_element=this.document.createElement('wbr');selection_element.id=id}try{clone_range.insertNode(selection_element)}catch(e){}}if(!window.opera){this.restore(null,true)}}return a},restore:function(a,b){if(a&&a.string){if(!this.range){this.range=this.get_range()}if(this.range.moveToBookmark&&this.range.moveToBookmark(a.string)){var c=this.range.duplicate();if(!a.collapsed){c.moveEnd('character',-2)}if(this.range.text==c.text){c.select()}else{this.range.select()}}}else if(a&&a.tagName){this.select_node(a)}else{var d=this.document.getElementById('reformator_selection_0');if(d){this.range=this.document.createRange();this.range.setStartAfter(d);var f=this.document.getElementById('reformator_selection_1');if(f){this.range.setEndBefore(f);if(!this.range.toString()){var g=this.range.cloneContents().childNodes;for(var i=0,collapse=true;i<g.length;i++){if(g[i].tagName&&g[i].id.indexOf('reformator_selection_')<0){collapse=false}}if(collapse){if(window.opera){this.range.setStartBefore(f)}this.collapse(true)}}}this.selection.removeAllRanges();try{this.selection.addRange(this.range)}catch(e){}}}},get_range:function(){var a;try{if(this.selection){if(this.selection.rangeCount>0){a=this.selection.getRangeAt(0)}else if(this.selection.createRange){a=this.selection.createRange()}else{a=this.document.createRange()}}}catch(error){};if(!a){a=this.document.createRange?this.document.createRange():this.document.body.createTextRange()}return a},get:function(){return this.window.getSelection?this.window.getSelection():this.document.selection}};reformator.language={init:function(){this.inited=true;this.upper_letters='';this.lower_letters='';for(var s in this.type){if(this.type.constructor.prototype[s])continue;this.type[s].upper=this.type[s].common_upper;this.upper_letters+=this.type[s].common_upper;this.type[s].lower=this.type[s].common_lower;this.lower_letters+=this.type[s].common_lower;this.type[s].common=this.type[s].common_upper+this.type[s].common_lower;this.type[s].common_pattern=new RegExp('['+this.type[s].common+']','g')}this.abc_length=0;for(var s in this.abc){this.abc_length++;if(this.abc.constructor.prototype[s])continue;this.abc[s].upper=this.type[this.abc[s].type].common_upper+this.abc[s].unique_upper;if(!this.type[this.abc[s].type].upper){this.type[this.abc[s].type].upper=''}this.type[this.abc[s].type].upper+=this.abc[s].unique_upper;this.upper_letters+=this.abc[s].unique_upper;this.abc[s].lower=this.type[this.abc[s].type].common_lower+this.abc[s].unique_lower;if(!this.type[this.abc[s].type].lower){this.type[this.abc[s].type].lower=''}this.type[this.abc[s].type].lower+=this.abc[s].unique_lower;this.lower_letters+=this.abc[s].unique_lower;this.abc[s].unique=this.abc[s].unique_upper+this.abc[s].unique_lower;this.abc[s].unique_pattern=new RegExp('['+this.abc[s].unique+']','g')}while(this.upper_letters.match(/(.)(.*?)\1/)){this.upper_letters=this.upper_letters.replace(/(.)(.*?)\1/g,'$1$2')}while(this.lower_letters.match(/(.)(.*?)\1/)){this.lower_letters=this.lower_letters.replace(/(.)(.*?)\1/g,'$1$2')}this.letters=this.upper_letters+this.lower_letters;this.simple_word_pattern=new RegExp('['+this.letters+'0-9’′\']')},get:function(d,e){if(!e){e={}}if(!e.limit){e.limit=5000}if(!e.limited_parts){e.limited_parts=5}d=d.replace(/[^\s]*_[^\s]*/g,' ');if(d.length>e.limit){var f=Math.floor(e.limit/e.limited_parts);var g=Math.floor((d.length-e.limit)/e.limited_parts);for(var i=0,limited_text='';i<e.limited_parts;i++){limited_text+=d.substr(i*g,f)}d=limited_text}var h=[],letters;for(var s in this.type){if(this.type.constructor.prototype[s])continue;letters=d.match(this.type[s].common_pattern);h[s]=letters?letters.length:0}var j=[],letters_count,i=0,max_letters_count=0,need_words=false,words;for(var s in this.abc){letters_count=h[this.abc[s].type];letters=d.match(this.abc[s].unique_pattern);if(letters_count||letters){if(letters){letters_count+=letters.length}if(max_letters_count<=letters_count){if((letters_count-max_letters_count)/letters_count<=0.01){need_words=true}max_letters_count=letters_count;j[i]={i:i,abbr:s,letters_count:letters_count};i++}}}if(need_words){for(i=0;i<j.length;i++){if(this.abc[j[i].abbr].words){words=d.match(this.abc[j[i].abbr].words);j[i].words_count=words?words.length:0}}j.sort(function(a,b){var c=b.letters_count>a.letters_count?(b.letters_count-a.letters_count)/b.letters_count:(a.letters_count>b.letters_count?(a.letters_count-b.letters_count)/a.letters_count:0);if(c<=0.01){return b.words_count==a.words_count?a.i-b.i:b.words_count-a.words_count}else{return b.letters_count-a.letters_count}})}else{j.sort(function(a,b){return a.letters_count>b.letters_count?-1:(a.letters_count==b.letters_count?a.i-b.i:1)})}return j[0]?j[0].abbr:''},type:{cyr:{common_upper:'АБВГДЕЖЗКЛМНОПРСТУФХЧШ',common_lower:'абвгдежзклмнопрстуфхчш'},lat:{common_upper:'ABDEGHILMNOPRSTU',common_lower:'abdeghilmnoprstu'}},abc:{ru:{name:'Russian',type:'cyr',unique_upper:'ЁИЙЦЩЪЫЬЭЮЯ',unique_lower:'ёийцщъыьэюя',words:/(?:\s|^)(и|в|не|на|с|что|а|как|то|из|по|он|все|это|его|к|еще|для|бы|же)(\s|$)/gi},en:{name:'English',type:'lat',unique_upper:'CFJKQVWXYZ',unique_lower:'cfjkqvwxyz',words:/(?:\s|^)(the|of|and|to|a|in|i|is|it|he|as|for|you|are|was|on|not|by|or|but)(\s|$)/gi},es:{name:'Spanish',type:'lat',unique_upper:'CFJKQVWXYZÁÉÍÑÓÚÜ',unique_lower:'cfjkqvwxyzáéíñóúü',words:/(?:\s|^)(de|el|la|y|que|en|a|los|un|se|no|es|las|una|por|del|me|con|su|al)(\s|$)/gi},fr:{name:'French',type:'lat',unique_upper:'CFJKQVWXYZÀÂÆÇÈÉÊËÎÏÔŒÙÛÜŸ',unique_lower:'cfjkqvwxyzàâæçèéêëîïôœùûüÿ',words:/(?:\s|^)(de|la|les|et|le|il|l'|à|des|un|d'|en|une|du|est|qui|par|que|au|ce)(\s|$)/gi},de:{name:'German',type:'lat',unique_upper:'CFJKQVWXYZÄÖßÜ',unique_lower:'cfjkqvwxyzäößü',words:/(?:\s|^)(und|der|die|ich|in|zu|von|den|das|mit|des|als|auf|so|ein|war|dem|an|ist|es)(\s|$)/gi},pt:{name:'Portuguese',type:'lat',unique_upper:'CFJQVXZÀÁÂÃÇÉÊÍÓÔÕÚÜ',unique_lower:'cfjqvxzàáâãçéêíóôõúü',words:/(?:\s|^)(de|e|a|o|que|do|da|um|uma|os|em|se|na|no|as|com|dos|por|ou|ele)(\s|$)/gi},it:{name:'Italian',type:'lat',unique_upper:'CFQVZÀÈÉÌÒÙ',unique_lower:'cfqvzàèéìòù',words:/(?:\s|^)(e|di|la|che|il|a|un|in|per|si|i|non|l\'|una|le|gli|da|del|ma|lo)(\s|$)/gi},tr:{name:'Turkish',type:'lat',unique_upper:'CFJKVYZÂÇĞİÖŞÜ',unique_lower:'cfjkvyzâçğıöşü'},pl:{name:'Polish',type:'lat',unique_upper:'CFJKWYZĄĆĘŁŃÓŚŹŻ',unique_lower:'cfjkwyząćęłńóśźż',words:/(?:\s|^)(i|w|na|nie|z|że|do|o|a|to|jak|ale|jej|od|ja|po|co|za|tak|ich)(\s|$)/gi},nl:{name:'Netherland',type:'lat',unique_upper:'CFJKQVWXYZÄÈÉËÏĲÖÜ',unique_lower:'cfjkqvwxyzäèéëïĳöü'},ro:{name:'Romanian',type:'lat',unique_upper:'CFJKVXZÂĂÎȘŢ',unique_lower:'cfjkvxzâăîșţ',words:/(?:\s|^)(şi|de|să|se|ca|în|o|a|la|cu|pe|nu|mai|ce|un|îi|din|i|el|cum)(\s|$)/gi},sv:{name:'Swedish',type:'lat',unique_upper:'CFJKQVWXYZÄÅÖÜ',unique_lower:'cfjkqvwxyzäåöü'},uk:{name:'Ukrainian',type:'cyr',unique_upper:'ҐЄІЇИЙЦЩЬЮЯ',unique_lower:'ґєіїийцщьюя',words:/(?:\s|^)(не|i|на|з|що|в|й|а|у|як|до|та|ще|це|ж|за|там|для|iз|чи)(\s|$)/gi},cs:{name:'Czech',type:'lat',unique_upper:'CFJKVYZÁČĎÉĚÍŇÓŘŠŤÚŮÝŽ',unique_lower:'cfjkvyzáčďéěíňóřšťúůýž',words:/(?:\s|^)(a|se|je|to|na|v|si|ale|ze|tak|o|mé|mi|co|pro|s|by|aby|z|byl)(\s|$)/gi},hu:{name:'Hungarian',type:'lat',unique_upper:'CFJKVZÁÉÍÓÖŐÚÜŰ',unique_lower:'cfjkvzáéíóöőúüű'},no:{name:'Norwegian',type:'lat',unique_upper:'CFJKQVWXYZÅÆØ',unique_lower:'cfjkqvwxyzåæø'},bg:{name:'Bulgarian',type:'cyr',unique_upper:'ИЙЦЩЪЬЮЯ',unique_lower:'ийцщъьюя',words:/(?:\s|^)(на|и|за|да|се|в|от|с|е|по|или|при|чл|са|не|ще|до|ус|те|има)(\s|$)/gi},fi:{name:'Finnish',type:'lat',unique_upper:'CFJKQVWXYZÄÅÖŠ',unique_lower:'cfjkqvwxyzäåöš'},be:{name:'Belarusian',type:'cyr',unique_upper:'ЁІЙЎЦЫЬЭЮЯ',unique_lower:'ёійўцыьэюя',words:/(?:\s|^)(і|у|на|ён|не|з|яго|што|але|ад|як|а|ўсё|да|па|за|ўжо|пад|іх|ж)(\s|$)/gi},sk:{name:'Slovak',type:'lat',unique_upper:'CFJKQVWXYZÁÄČĎÉÍŇÓÔŔŠŤÚÝŽ',unique_lower:'cfjkqvwxyzáäčďéíňóôŕšťúýž'},ga:{name:'Irish',type:'lat',unique_upper:'CFÁÉÍÓÚ',unique_lower:'cfáéíóú'},hr:{name:'Croatian',type:'lat',unique_upper:'CFJKVZĆČĐŠŽ',unique_lower:'cfjkvzćčđšž'},kk:{name:'Kazakh',type:'cyr',unique_upper:'ӘҒЁІИЙҚҢӨҰҮҺЦЩЪЫЬЭЮЯ',unique_lower:'әғёіийқңөұүһцщъыьэюя',words:/(?:\s|^)(мен|бір|де|бұл|да|бар|жж|осы|өз|ол|шет|ету|әр|ж|қр|жыл|ақ|деп|екі|іс)(\s|$)/gi},lt:{name:'Lithuanian',type:'lat',unique_upper:'CFJKXYZĄČĖĘĮŠŪŲŽ',unique_lower:'cfjkxyząčėęįšūųž'},lv:{name:'Latvian',type:'lat',unique_upper:'CFJKVZĀČĒĢĪĶĻŅŠŪŽ',unique_lower:'cfjkvzāčēģīķļņšūž',words:/(?:\s|^)(un|ir|kā|ar|kas|no|par|to|tā|vai|uz|tas|bet|jau|var|lai|gan|ko|nav|ja)(\s|$)/gi},da:{name:'Danish',type:'lat',unique_upper:'CFJKQVWXYZÅÆØ',unique_lower:'cfjkqvwxyzåæø'},sl:{name:'Slovene',type:'lat',unique_upper:'CFJKVZČŠŽ',unique_lower:'cfjkvzčšž'},et:{name:'Estonian',type:'lat',unique_upper:'FJKVZÄÕÖŠÜ',unique_lower:'fjkvzäõöšü'},mo:{name:'Moldavian',type:'cyr',unique_upper:'ӁИЙЦЫЬЭЮЯ',unique_lower:'ӂийцыьэюя'},sq:{name:'Albanian',type:'lat',unique_upper:'CFJKQVXYZÇË',unique_lower:'cfjkqvxyzçë'},eo:{name:'Esperanto',type:'lat',unique_upper:'CFJKVZĈĜĤĴŜŬ',unique_lower:'cfjkvzĉĝĥĵŝŭ'},el:{name:'Greek',type:'lat',unique_upper:'ΑΒΓΔΕΖΗΘΙΚΛΜΝΞΟΠΡΣΤΥΦΧΨΩϜϚϘϠ',unique_lower:'αβγδεζηθικλμνξοπρσςτυφχψωϝϛϙϡ'},ky:{name:'Kirghiz',type:'cyr',unique_upper:'ЁИЙҢӨҮЦЩЪЫЬЭЮЯ',unique_lower:'ёийңөүцщъыьэюя'},os:{name:'Ossetic',type:'cyr',unique_upper:'ӔЁИЙЦЩЪЫЬЭЮЯ',unique_lower:'ӕёийцщъыьэюя'},tg:{name:'Tajik',type:'cyr',unique_upper:'ҒЁИЙӢҚӮҲҶЪЭЮЯ',unique_lower:'ғёийӣқӯҳҷъэюя'}}};reformator.html={remove_tags:function(a){return a.replace(/<(?:[\/\?\!]?\w+[^>]*|\!--(?:.|\n)*?--|%(?:.|\n)*?%)>/g,'')},remove_entities:function(a){return a.replace(/&([a-zA-Z\d]|\#\d+);/g,'\x20')},replace_entities:function(a,b){if(!b){b={}}if(!b.group){b.group='common'}if(!b.type){b.type=0}if(!this.pattern){this.pattern=[]}var i,replaced=[];for(var s in this.entities[b.group]){for(i=0;i<4;i++){if(i!=b.type){if(!replaced[this.entities[b.group][s][i]]&&this.entities[b.group][s][b.type]){replaced[this.entities[b.group][s][i]]=true;if(!this.pattern[this.entities[b.group][s][i]]){this.pattern[this.entities[b.group][s][i]]=new RegExp(this.entities[b.group][s][i],'g')}a=a.replace(this.pattern[this.entities[b.group][s][i]],this.entities[b.group][s][b.type])}}}}return a},init:function(){this.inited=true;var a,ss;for(var s in this.tags.all){if(this.tags.all.constructor.prototype[s])continue;this.tags.all[s].name=s.toLowerCase();if(!this.tags.all[s].attributes){this.tags.all[s].attributes={}}a=this.tags.all[s].attributes;a['class']={};a['title']={};for(ss in a){if(a.constructor.prototype[ss])continue;a[ss].name=ss.toLowerCase()}this.tags.all[s.toUpperCase()]=this.tags.all[s]}},tags:{all:{a:{inline:true,attributes:{href:{},name:{},target:{}}},abbr:{inline:true},acronym:{inline:true},address:{block:true,inline_only:true},applet:{deprecated:true,remove:true},area:{empty:true,parents:{map:{}},attributes:{alt:{},coords:{},href:{},shape:{}}},audio:{block:true,inline:true,attributes:{src:{},controls:{},autoplay:{},preload:{},loop:{}},can_be_empty:true},b:{inline:true,replace_with:'strong'},base:{empty:true,parents:{head:{}},attributes:{href:{}}},bdo:{inline:true,attributes:{dir:{}}},basefont:{deprecated:true,empty:true},big:{inline:true,replace_with:'strong'},blockquote:{block:true},body:{block:true},br:{inline:true,empty:true},button:{inline:true,attributes:{id:{},name:{},value:{}}},caption:{block:true,inline_only:true,parents:{table:{}},can_be_empty:true},center:{block:true,deprecated:true,remove:true},cite:{inline:true},code:{inline:true,dont_modify_text:true},col:{empty:true,parents:{colgroup:{}}},colgroup:{block:true,parents:{table:{}}},dd:{block:true,parents:{dl:{}}},del:{inline:true},dfn:{inline:true},dir:{block:true,deprecated:true,replace_with:'ul'},div:{block:true},dl:{block:true,children:{dt:{},dd:{}}},dt:{block:true,inline_only:true,parents:{dl:{}}},em:{inline:true},embed:{block:true,inline:true,attributes:{src:{},type:{},allowfullscreen:'',width:{},height:{}},can_be_empty:true},fieldset:{block:true},font:{inline:true,deprecated:true,remove:true},form:{block:true,attributes:{id:{},name:{},action:{},method:{}}},frame:{block:true,attributes:{name:{},src:{}}},frameset:{block:true},h1:{block:true,inline_only:true},h2:{block:true,inline_only:true},h3:{block:true,inline_only:true},h4:{block:true,inline_only:true},h5:{block:true,inline_only:true},h6:{block:true,inline_only:true},head:{block:true,parents:{html:{}}},hr:{block:true,empty:true},html:{block:true},i:{inline:true,replace_with:'em'},iframe:{block:true,attributes:{name:{},src:{},width:{},height:{}}},img:{inline:true,empty:true,attributes:{src:{},alt:{},width:{},height:{},usemap:{}}},input:{inline:true,empty:true,attributes:{id:{},name:{},value:{},checked:{},type:{},length:{},maxlength:{}}},ins:{block:true,inline:true},isindex:{block:true,empty:true,deprecated:true,remove:true,attributes:{prompt:{}}},kbd:{inline:true},label:{inline:true,attributes:{'for':{}}},legend:{block:true,inline_only:true},li:{block:true,parents:{ul:{},ol:{}}},link:{empty:true,parents:{head:{}},attributes:{src:{},type:{},rel:{}}},map:{attributes:{name:{}}},menu:{block:true,deprecated:true,replace_with:'ul'},meta:{empty:true,parents:{head:{}}},nobr:{inline:true},noframes:{block:true,remove:true},noscript:{block:true,remove:true},object:{block:true,inline:true,attributes:{width:{},height:{},data:{},type:{}},can_be_empty:true},ol:{block:true,children:{li:{}}},optgroup:{block:true,parents:{select:{}}},option:{block:true,inline:true,parents:{select:{},optgroup:{}},attributes:{value:{},selected:{}}},p:{block:true,inline_only:true},param:{empty:true,parents:{object:{},applet:{}},attributes:{name:{},value:{}}},pre:{block:true,preformatted:true},q:{inline:true},s:{inline:true,deprecated:true,replace_with:'del'},samp:{inline:true,dont_modify_text:true},script:{block:true,remove_with_content:true,preformatted:true,attributes:{src:{},type:{}}},select:{block:true,inline:true,attributes:{id:{},name:{}}},small:{inline:true,remove:true},span:{inline:true,remove_without_class:true},strike:{inline:true,deprecated:true,replace_with:'del'},strong:{inline:true},style:{block:true,remove_with_content:true,preformatted:true,attributes:{type:{}}},sub:{inline:true},sup:{inline:true},table:{block:true,children:{caption:{},thead:{},tbody:{},tfoot:{},tr:{},td:{},th:{}}},tbody:{block:true,parents:{table:{}},children:{tr:{},td:{},th:{}}},td:{block:true,can_be_empty:true,parents:{tr:{}},attributes:{colspan:{null_value:'1'},rowspan:{null_value:'1'}}},textarea:{can_be_empty:true,attributes:{id:{},name:{},value:{},cols:{},rows:{}}},tfoot:{block:true,parents:{table:{}},children:{tr:{},td:{},th:{}}},th:{block:true,can_be_empty:true,parents:{tr:{}},attributes:{colspan:{null_value:'1'},rowspan:{null_value:'1'}}},thead:{block:true,parents:{table:{}},children:{tr:{},td:{},th:{}}},title:{parents:{head:{}}},tr:{block:true,parents:{table:{},tbody:{},thead:{},tfoot:{}},children:{td:{},th:{}}},tt:{},u:{inline:true,deprecated:true,replace_with:'strong'},ul:{block:true,children:{li:{}}},wbr:{inline:true,empty:true},'var':{inline:true,dont_modify_text:true},video:{block:true,inline:true,attributes:{src:{},controls:{},autoplay:{},preload:{},loop:{},width:{},height:{},audio:{},poster:{}},can_be_empty:true}}},entities:{special:{amp:['&','&amp;','&amp;','&#38;'],gt:['>','&gt;','&gt;','&#62;'],lt:['<','&lt;','&lt;','&#60;'],quot:['\"','&quot;','&quot;','&#34;']},common:{Aacute:['Á','&Aacute;','&Aacute;','&#193;'],aacute:['á','&aacute;','&aacute;','&#225;'],Acirc:['Â','&Acirc;','&Acirc;','&#194;'],acirc:['â','&acirc;','&acirc;','&#226;'],acute:['´','&acute;','&acute;','&#180;'],AElig:['Æ','&AElig;','&AElig;','&#198;'],aelig:['æ','&aelig;','&aelig;','&#230;'],Agrave:['À','&Agrave;','&Agrave;','&#192;'],agrave:['à','&agrave;','&agrave;','&#224;'],alefsym:['ℵ','&alefsym;','&alefsym;','&#8501;'],Alpha:['Α','&Alpha;','&Alpha;','&#913;'],alpha:['α','&alpha;','&alpha;','&#945;'],Aring:['Å','&Aring;','&Aring;','&#197;'],aring:['å','&aring;','&aring;','&#229;'],asymp:['≈','&asymp;','&asymp;','&#8776;'],Atilde:['Ã','&Atilde;','&Atilde;','&#195;'],atilde:['ã','&atilde;','&atilde;','&#227;'],Auml:['Ä','&Auml;','&Auml;','&#196;'],auml:['ä','&auml;','&auml;','&#228;'],bdquo:['„','&#132;','&bdquo;','&#8222;'],Beta:['Β','&Beta;','&Beta;','&#914;'],beta:['β','&beta;','&beta;','&#946;'],brvbar:['¦','&brvbar;','&brvbar;','&#166;'],bsquo:[',',',',',',','],bull:['•','&bull;','&bull;','&#8226;'],cap:['∩','&cap;','&cap;','&#8745;'],Ccedil:['Ç','&Ccedil;','&Ccedil;','&#199;'],ccedil:['ç','&ccedil;','&ccedil;','&#231;'],cedil:['¸','&cedil;','&cedil;','&#184;'],cent:['¢','&cent;','&cent;','&#162;'],Chi:['Χ','&Chi;','&Chi;','&#935;'],chi:['χ','&chi;','&chi;','&#967;'],circ:['ˆ','&circ;','&circ;','&#710;'],clubs:['♣','&clubs;','&clubs;','&#9827;'],cong:['≅','&cong;','&cong;','&#8773;'],'combining acute accent':[String.fromCharCode(769),'&#769;','&#769;','&#769;'],copy:['©','&copy;','&copy;','&#169;'],crarr:['↵','&crarr;','&crarr;','&#8629;'],curren:['¤','&curren;','&curren;','&#164;'],dagger:['†','&dagger;','&dagger;','&#8224;'],Dagger:['‡','&Dagger;','&Dagger;','&#8225;'],darr:['↓','&darr;','&darr;','&#8595;'],dArr:['⇓','&dArr;','&dArr;','&#8659;'],deg:['°','&deg;','&deg;','&#176;'],Delta:['Δ','&Delta;','&Delta;','&#916;'],delta:['δ','&delta;','&delta;','&#948;'],diams:['♦','&diams;','&diams;','&#9830;'],divide:['÷','&divide;','&divide;','&#247;'],Eacute:['É','&Eacute;','&Eacute;','&#201;'],eacute:['é','&eacute;','&eacute;','&#233;'],Ecirc:['Ê','&Ecirc;','&Ecirc;','&#202;'],ecirc:['ê','&ecirc;','&ecirc;','&#234;'],Egrave:['È','&Egrave;','&Egrave;','&#200;'],egrave:['è','&egrave;','&egrave;','&#232;'],empty:['∅','&empty;','&empty;','&#8709;'],Epsilon:['Ε','&Epsilon;','&Epsilon;','&#917;'],epsilon:['ε','&epsilon;','&epsilon;','&#949;'],equiv:['≡','&equiv;','&equiv;','&#8801;'],Eta:['Η','&Eta;','&Eta;','&#919;'],eta:['η','&eta;','&eta;','&#951;'],ETH:['Ð','&ETH;','&ETH;','&#208;'],eth:['ð','&eth;','&eth;','&#240;'],Euml:['Ë','&Euml;','&Euml;','&#203;'],euml:['ë','&euml;','&euml;','&#235;'],euro:['€','&euro;','&euro;','&#8364;'],fnof:['ƒ','&fnof;','&fnof;','&#402;'],frac12:['½','&frac12;','&frac12;','&#189;'],frac14:['¼','&frac14;','&frac14;','&#188;'],frac34:['¾','&frac34;','&frac34;','&#190;'],frasl:['⁄','&frasl;','&frasl;','&#8260;'],Gamma:['Γ','&Gamma;','&Gamma;','&#915;'],gamma:['γ','&gamma;','&gamma;','&#947;'],ge:['≥','&ge;','&ge;','&#8805;'],harr:['↔','&harr;','&harr;','&#8596;'],hearts:['♥','&hearts;','&hearts;','&#9829;'],hellip:['…','&#133;','&hellip;','&#133;'],Iacute:['Í','&Iacute;','&Iacute;','&#205;'],iacute:['í','&iacute;','&iacute;','&#237;'],Icirc:['Î','&Icirc;','&Icirc;','&#206;'],icirc:['î','&icirc;','&icirc;','&#238;'],iexcl:['¡','&iexcl;','&iexcl;','&#161;'],Igrave:['Ì','&Igrave;','&Igrave;','&#204;'],igrave:['ì','&igrave;','&igrave;','&#236;'],image:['ℑ','&image;','&image;','&#8465;'],infin:['∞','&infin;','&infin;','&#8734;'],integral:['∫','&int;','&int;','&#8747;'],Iota:['Ι','&Iota;','&Iota;','&#921;'],iota:['ι','&iota;','&iota;','&#953;'],iquest:['¿','&iquest;','&iquest;','&#191;'],Iuml:['Ï','&Iuml;','&Iuml;','&#207;'],iuml:['ï','&iuml;','&iuml;','&#239;'],Kappa:['Κ','&Kappa;','&Kappa;','&#922;'],kappa:['κ','&kappa;','&kappa;','&#954;'],Lambda:['Λ','&Lambda;','&Lambda;','&#923;'],lambda:['λ','&lambda;','&lambda;','&#955;'],laquo:['«','&laquo;','&laquo;','&#171;'],lArr:['⇐','&lArr;','&lArr;','&#8656;'],larr:['←','&larr;','&larr;','&#8592;'],lceil:['⌈','&lceil;','&lceil;','&#8968;'],ldquo:['“','&#147;','&ldquo;','&#147;'],le:['≤','&le;','&le;','&#8804;'],lfloor:['⌊','&lfloor;','&lfloor;','&#8970;'],lowast:['∗','&lowast;','&lowast;','&#8727;'],loz:['◊','&loz;','&loz;','&#9674;'],lsaquo:['‹','&lsaquo;','&lsaquo;','&#8249;'],lsquo:['‘','&#145;','&lsquo;','&#145;'],macr:['¯','&macr;','&macr;','&#175;'],mdash:['—','&#151;','&mdash;','&#8212;'],micro:['µ','&micro;','&micro;','&#181;'],middot:['·','&middot;','&middot;','&#183;'],minus:['−','&minus;','&minus;','&#8722;'],Mu:['Μ','&Mu;','&Mu;','&#924;'],mu:['μ','&mu;','&mu;','&#956;'],nbsp:[String.fromCharCode(160),'&nbsp;','&nbsp;','&#160;'],ndash:['–','&#150;','&ndash;','&#8211;'],ne:['≠','&ne;','&ne;','&#8800;'],not:['¬','&not;','&not;','&#172;'],notin:['∉','&notin;','&notin;','&#8713;'],nsub:['⊄','&nsub;','&nsub;','&#8836;'],Ntilde:['Ñ','&Ntilde;','&Ntilde;','&#209;'],ntilde:['ñ','&ntilde;','&ntilde;','&#241;'],Nu:['Ν','&Nu;','&Nu;','&#925;'],nu:['ν','&nu;','&nu;','&#957;'],num:['№','&#8470;','&#8470;','&#8470;'],Oacute:['Ó','&Oacute;','&Oacute;','&#211;'],oacute:['ó','&oacute;','&oacute;','&#243;'],Ocirc:['Ô','&Ocirc;','&Ocirc;','&#212;'],ocirc:['ô','&ocirc;','&ocirc;','&#244;'],OElig:['Œ','&OElig;','&OElig;','&#338;'],oelig:['œ','&oelig;','&oelig;','&#339;'],Ograve:['Ò','&Ograve;','&Ograve;','&#210;'],ograve:['ò','&ograve;','&ograve;','&#242;'],oline:['‾','&oline;','&oline;','&#8254;'],Omega:['Ω','&Omega;','&Omega;','&#937;'],omega:['ω','&omega;','&omega;','&#969;'],Omicron:['Ο','&Omicron;','&Omicron;','&#927;'],omicron:['ο','&omicron;','&omicron;','&#959;'],ordf:['ª','&ordf;','&ordf;','&#170;'],ordm:['º','&ordm;','&ordm;','&#186;'],Oslash:['Ø','&Oslash;','&Oslash;','&#216;'],oslash:['ø','&oslash;','&oslash;','&#248;'],Otilde:['Õ','&Otilde;','&Otilde;','&#213;'],otilde:['õ','&otilde;','&otilde;','&#245;'],otimes:['⊗','&otimes;','&otimes;','&#8855;'],Ouml:['Ö','&Ouml;','&Ouml;','&#214;'],ouml:['ö','&ouml;','&ouml;','&#246;'],para:['¶','&para;','&para;','&#182;'],part:['∂','&part;','&part;','&#8706;'],permil:['‰','&permil;','&permil;','&#8240;'],Phi:['Φ','&Phi;','&Phi;','&#934;'],phi:['φ','&phi;','&phi;','&#966;'],Pi:['Π','&Pi;','&Pi;','&#928;'],pi:['π','&pi;','&pi;','&#960;'],piv:['ϖ','&piv;','&piv;','&#982;'],plusmn:['±','&plusmn;','&plusmn;','&#177;'],pound:['£','&pound;','&pound;','&#163;'],prime:['′','&prime;','&prime;','&#8242;'],Prime:['″','&Prime;','&Prime;','&#8243;'],prod:['∏','&prod;','&prod;','&#8719;'],Psi:['Ψ','&Psi;','&Psi;','&#936;'],psi:['ψ','&psi;','&psi;','&#968;'],radic:['√','&radic;','&radic;','&#8730;'],raquo:['»','&raquo;','&raquo;','&#187;'],rarr:['→','&rarr;','&rarr;','&#8594;'],rceil:['⌉','&rceil;','&rceil;','&#8969;'],rdquo:['”','&#148;','&rdquo;','&#8221;'],real:['ℜ','&real;','&real;','&#8476;'],reg:['®','&reg;','&reg;','&#174;'],rfloor:['⌋','&rfloor;','&rfloor;','&#8971;'],Rho:['Ρ','&Rho;','&Rho;','&#929;'],rho:['ρ','&rho;','&rho;','&#961;'],rur:['₽','₽','₽','&#8381;'],rsaquo:['›','&rsaquo;','&rsaquo;','&#8250;'],rsquo:['’','&#146;','&rsquo;','&#146;'],sbquo:['‚','&sbquo;','&sbquo;','&#8218;'],Scaron:['Š','&Scaron;','&Scaron;','&#352;'],scaron:['š','&scaron;','&scaron;','&#353;'],sdot:['⋅','&sdot;','&sdot;','&#8901;'],sect:['§','&sect;','&sect;','&#167;'],shy:[String.fromCharCode(173),'&shy;','&shy;','&#173;'],Sigma:['Σ','&Sigma;','&Sigma;','&#931;'],sigma:['σ','&sigma;','&sigma;','&#963;'],sigmaf:['ς','&sigmaf;','&sigmaf;','&#962;'],spades:['♠','&spades;','&spades;','&#9824;'],sum:['∑','&sum;','&sum;','&#8721;'],sup1:['¹','&sup1;','&sup1;','&#185;'],sup2:['²','&sup2;','&sup2;','&#178;'],sup3:['³','&sup3;','&sup3;','&#179;'],szlig:['ß','&szlig;','&szlig;','&#223;'],Tau:['Τ','&Tau;','&Tau;','&#932;'],tau:['τ','&tau;','&tau;','&#964;'],Theta:['Θ','&Theta;','&Theta;','&#920;'],theta:['θ','&theta;','&theta;','&#952;'],thetasym:['ϑ','&thetasym;','&thetasym;','&#977;'],THORN:['Þ','&THORN;','&THORN;','&#222;'],thorn:['þ','&thorn;','&thorn;','&#254;'],tilde:['˜','&tilde;','&tilde;','&#732;'],times:['×','&times;','&times;','&#215;'],trade:['™','&trade;','&trade;','&#8482;'],Uacute:['Ú','&Uacute;','&Uacute;','&#218;'],uacute:['ú','&uacute;','&uacute;','&#250;'],uarr:['↑','&uarr;','&uarr;','&#8593;'],uArr:['⇑','&uArr;','&uArr;','&#8657;'],Ucirc:['Û','&Ucirc;','&Ucirc;','&#219;'],ucirc:['û','&ucirc;','&ucirc;','&#251;'],Ugrave:['Ù','&Ugrave;','&Ugrave;','&#217;'],ugrave:['ù','&ugrave;','&ugrave;','&#249;'],uml:['¨','&uml;','&uml;','&#168;'],upsih:['ϒ','&upsih;','&upsih;','&#978;'],Upsilon:['Υ','&Upsilon;','&Upsilon;','&#933;'],upsilon:['υ','&upsilon;','&upsilon;','&#965;'],Uuml:['Ü','&Uuml;','&Uuml;','&#220;'],uuml:['ü','&uuml;','&uuml;','&#252;'],weierp:['℘','&weierp;','&weierp;','&#8472;'],Xi:['Ξ','&Xi;','&Xi;','&#926;'],xi:['ξ','&xi;','&xi;','&#958;'],Yacute:['Ý','&Yacute;','&Yacute;','&#221;'],yacute:['ý','&yacute;','&yacute;','&#253;'],yen:['¥','&yen;','&yen;','&#165;'],yuml:['ÿ','&yuml;','&yuml;','&#255;'],Yuml:['Ÿ','&Yuml;','&Yuml;','&#376;'],Zeta:['Ζ','&Zeta;','&Zeta;','&#918;'],zeta:['ζ','&zeta;','&zeta;','&#950;']}}};reformator.typograph={process:function(a,b){this.text=a;if(a){if(!this.inited){this.init('')}this.text='\x0A'+this.text+'\x0A';this.init_params(b);this.cut_html();this.init_params_by_language(b);this.pre_process();this.open_nobr();this.place_nbsp();this.dash_process();if(this.params.quotation_marks_a&&!this.params.preserve_original_quotation){this.place_quotation(this.params.quotation_marks_a,this.params.quotation_marks_b)}this.post_process();this.return_html();this.close_nobr();this.replace('(^\\n|\\n$)','g','')}return this.text},init_params:function(a){this.params={entity_type:0,entity_type_for_nbsp:1,entity_type_for_shy:1,entity_type_for_special:1,preserve_original_nbsp:false,symbols_number_for_nbsp:2,collapse_09:false,collapse_20:true,collapse_0A:true,replace_copy:true,replace_plusmn:true,replace_reg:true,replace_trade:true,replace_times:true,replace_hellip:false,no_tags:false,preserve_original_nobr:false,symbols_number_for_nobr:2,nobr:true,nobr_phone:true,preserve_original_minus:false,preserve_original_quotation:false};if(a){for(var s in a){if(a.constructor.prototype[s])continue;this.params[s]=a[s]}}},cut_html:function(){var t=this;var s;this.tags=[];this.tag_counter=0;this.replace('(</[a-z][a-z\\d]*>)(?=<(?:p|h[1-6]|div|li|dd|pre|[hb]r|blockquote|address|fieldset|t[dh]|form|section|header|footer|article|aside|figure|dialog|video|audio|menu|details)(?:\\s+[^>]*)?>)','gi','$1 ');this.replace('(<(?:\\!--(?:.|\\n)*?--|%(?:.|\\n)*?%)>)','gi',function(a,b){t.tags[t.tag_counter]=b;var s=t.p.tag_begin+t.tag_counter+t.p.tag_end;t.tag_counter++;return s});this.replace_cyclic('(<(style|script|code|var|samp)(\\s[^>]*)?>(?:.|\\n)*?<\\/\\2>)','gi',function(a,b){t.tags[t.tag_counter]=b;var s=t.p.tag_begin+t.tag_counter+t.p.tag_end;t.tag_counter++;return s});if(this.params.nobr&&!this.params.preserve_original_nobr){this.replace('<nobr(?:\\s+[^>]*)?>','g','')}this.replace('<\\/nobr>','g','');this.replace('([^\\n])(<([a-z]+)([^>]*)?>)','gi',function(a,b,c,d){var s=(reformator.html.tags.all[d]&&reformator.html.tags.all[d].block)||d=='br'?'\x0A':'';t.tags[t.tag_counter]=s+c;s=b+s+t.p.tag_begin+t.tag_counter+t.p.tag_end;t.tag_counter++;return s});this.replace('((<[!?\\/a-z][^>]*>)+)','gi',function(a,b){t.tags[t.tag_counter]=b;var s=t.p.tag_begin+t.tag_counter+t.p.tag_end;t.tag_counter++;return s});this.text=reformator.html.replace_entities(this.text);this.text=reformator.html.replace_entities(this.text,{group:'special'});this.replace('((?:&#\\d+;\\s*)+)','g',function(a,b){t.tags[t.tag_counter]=b;var s=t.p.tag_begin+t.tag_counter+t.p.tag_end;t.tag_counter++;return s});return},init_params_by_language:function(a){var b=this.params.language?this.params.language:reformator.language.get(this.text);switch(b){case'cyr':case'ru':case'be':case'uk':case'bg':case'lv':case'kk':case'mo':case'ky':case'os':case'tg':this.params.quotation_marks_a='laquo raquo';this.params.quotation_marks_b='bdquo ldquo';break;case'fr':case'pt':case'es':case'el':case'ca':this.params.quotation_marks_a='laquo raquo';this.params.quotation_marks_b='ldquo rdquo';break;case'sq':case'it':case'tr':this.params.quotation_marks_a='laquo raquo';this.params.quotation_marks_b='lsaquo rsaquo';break;case'cs':case'lt':case'sk':case'sl':case'ro':case'pl':case'nl':case'et':case'hr':this.params.quotation_marks_a='bdquo rdquo';this.params.quotation_marks_b='sbquo rsquo';break;case'de':case'da':this.params.quotation_marks_a='raquo laquo';this.params.quotation_marks_b='rsaquo lsaquo';break;case'hu':this.params.quotation_marks_a='bdquo rdquo';this.params.quotation_marks_b='raquo laquo';break;case'no':this.params.quotation_marks_a='laquo raquo';this.params.quotation_marks_b='rsquo rsquo';break;case'fi':case'sv':this.params.quotation_marks_a='rdquo rdquo';this.params.quotation_marks_b='rsquo rsquo';break;case'lat':case'en':case'eo':case'ga':case'id':case'ko':case'th':case'zh':this.params.quotation_marks_a='ldquo rdquo';this.params.quotation_marks_b='lsquo rsquo';break}if(a){for(var s in a){if(a.constructor.prototype[s])continue;this.params[s]=a[s]}}},pre_process:function(){if(this.params.quotation_marks_a&&!this.params.preserve_original_quotation){this.replace('[″«»“”„‹›]','g','"')}if(!this.params.preserve_original_nbsp){this.replace(this.e.nbsp[0],'g','\x20')}if(!this.params.preserve_original_minus){this.replace('([\xC2\x96\xC2\x97–—−]|(^|[^-])--(?!\\s*-))','g','$2—')}if(this.params.collapse_09){this.replace('\\x09+','g','\x20')}if(this.params.collapse_20){this.replace('\x20{2,}','g','\x20');this.replace('(^|\\n)\x20+','g','$1')}if(this.params.replace_plusmn){this.replace('\\+\\-','g',this.e.plusmn[0])}if(this.params.replace_copy){this.replace('\\([cс]\\)','gi',this.e.copy[0])}if(this.params.replace_reg){this.replace('\\(r\\)','gi',this.e.reg[0])}if(this.params.replace_trade){this.replace('(\\S)\\(tm\\)','gi','$1'+this.e.trade[0])}if(this.params.replace_hellip){this.replace('([^\\.]|^)\\.{3,3}(?=[^\\.]|$)','g','$1'+this.e.hellip[0])}else{this.replace(this.e.hellip[0],'g','...')}if(this.params.replace_times){this.replace('(\\d'+this.p.tag+')\x20?('+this.p.tag+')[xх]('+this.p.tag+')\x20?('+this.p.tag+'\\d)','g','$1$2'+this.e.times[0]+'$3$4')}this.replace('('+this.p.letters+'{2})(\')(?='+this.p.letters+'{0,2}'+this.p.word_end_0s+')','g','$1'+this.e.rsquo[0]);this.replace('(\\n'+this.p.tag+'\\s*'+this.p.tag+'\\s*|'+this.p.sentence_end+'\x20'+this.p.tag+')[\\-\\—]('+this.p.tag+')\x20','g','$1'+this.e.mdash[0]+'$2'+this.e.nbsp[0]);this.replace('('+this.p.letters_digits+this.p.word_end_0+')\x20('+this.p.tag+')[\\-\\—](?='+this.p.tag+'\x20)','g','$1'+this.e.nbsp[0]+'$2'+this.e.mdash[0]);return},open_nobr:function(){var t=this;if(this.params.nobr&&!this.params.no_tags){this.tag_counter.inc++;this.tags[this.tag_counter]='<nobr>';this.replace('(\\s|^)('+this.p.word_begin_0+'(?:'+this.p.number+'[\\-\\—]'+this.p.number+'|'+this.p.roman_number+'\\—'+this.p.roman_number+'))(?='+this.p.word_end_0s+')','gi',function(a,b,c){return b+t.p.tag_begin+t.tag_counter+t.p.tag_end+c});this.replace('(\\s|^)('+this.p.word_begin_0+'(?:'+this.p.number+'|'+this.p.roman_number+')-'+this.p.letters+'+)(?='+this.p.word_end_0s+')','gi',function(a,b,c){return b+t.p.tag_begin+t.tag_counter+t.p.tag_end+c})}if(this.params.nobr_phone&&!this.params.no_tags){this.tag_counter++;this.tags[this.tag_counter]='<nobr class="phone">';var r=this.make_regular_expression('(\\d\\-\\d+\\-\\d|\\+(?:\\d\x20?){11})');this.replace('(\\s|^)('+this.p.word_begin_0+'\\+?(?:\\d(?:[\\-\\\x28\\\x29\x20]*|'+this.p.tag+')){5,11})(?='+this.p.word_end_0s+')','g',function(a,b,c){return b+(c.match(r)?t.p.tag_begin+t.tag_counter+t.p.tag_end+c.replace(/\x20/g,t.e.nbsp[0]):c)})}return},place_nbsp:function(){var t=this;this.replace('(\\d'+this.p.tag+')\x20(?='+this.p.tag+'\\d{3}'+this.p.word_end_0s+')','g','$1'+this.e.nbsp[0]);this.replace('(\\S)\x20(?='+this.p.word_begin_0+this.p.exceptions_left+this.p.word_end_0s+')','g','$1&_;');this.replace('([№§]'+this.p.tag+')\x20?(?='+this.p.tag+'(?:'+this.p.number+'|'+this.p.roman_number+'))','g','$1'+this.e.nbsp[0]);this.replace('\x20([\\/\\|])\x20','g',this.e.nbsp[0]+'$1\x20');this.replace('((?:'+this.p.number+'|'+this.p.roman_number+')'+this.p.nulls+')\x20(?='+this.p.tag+'('+this.p.letters+'+'+this.p.word_end_1s+'|'+this.p.letters_upper+'{2}|'+this.p.letters+'+\\/|(?!'+this.p.exceptions_right+this.p.word_end_0s+')'+this.p.letters+'{1,'+this.params.symbols_number_for_nbsp+'}'+this.p.word_end_0s+'))','g','$1&_;');this.replace('('+this.p.word_begin_0s+this.p.letters_upper+this.p.letters_lower+'*'+this.p.nulls+')\x20(?='+this.p.nulls+'\\d{1,'+this.params.symbols_number_for_nbsp+'}(?:'+this.p.word_end_1+'|'+this.p.word_begin_0s+this.p.letters_upper+'))','g','$1&_;');this.replace('('+this.p.word_begin_0s+this.p.letters_lower+'+'+this.p.nulls+')\x20(?='+this.p.nulls+'(?:'+this.p.letters_upper+this.p.letters+'{0,'+(this.params.symbols_number_for_nbsp-1)+'}'+this.p.word_end_s+'(?='+this.p.tag+this.p.letters_lower+')|'+this.p.letters_lower+'{1,'+this.params.symbols_number_for_nbsp+'}(?:'+this.p.word_end_1s+'|'+this.p.word_begin_2s+')))','g','$1&_;');this.replace('('+this.p.word_begin_0s+this.p.letters_digits+'+'+this.p.nulls+')\x20(?='+this.p.nulls+'(?:'+this.p.letters_digits+'{1,'+this.params.symbols_number_for_nbsp+'}(?:'+this.p.word_end_0s+'$|'+this.p.word_begin_2s+'|'+this.p.word_end_1s+this.p.word_begin_0+this.p.letters_lower+')))','g','$1&_;');this.replace('('+this.p.letters_upper+this.p.letters_lower+'+'+this.p.nulls+')\x20('+this.p.tag+this.p.letters_upper+this.p.nulls+'\\.'+this.p.nulls+')(?:\x20('+this.p.tag+this.p.letters_upper+this.p.nulls+'\\.'+this.p.nulls+'))?(?='+this.p.word_end_1s+'|'+this.p.tag+'(?:\\s*\\n|\\s'+this.p.word_begin_0+this.p.letters_lower+'))','g',function(a,b,c,d){return b+'&_;'+c+(d?'&_;'+d:'')});this.replace_cyclic('('+this.p.word_begin_0s+this.p.letters_digits+'{0,'+(this.params.symbols_number_for_nbsp-1)+'}(?!\\d'+this.p.nulls+'\x20'+this.p.word_begin_0+'\\d)'+this.p.letters_digits+this.p.nulls+')\x20(?='+this.p.word_begin_0+this.p.letters_digits+')','g','$1'+this.e.nbsp[0]);this.replace('((?:\\n\\s*|'+this.p.not_letters_upper+this.p.word_end_1s+'|'+this.p.word_begin_1+'|'+this.p.word_begin_0s+this.p.letters_lower+'+'+this.p.word_end_0s+')'+this.p.word_begin_0+this.p.letters_upper+this.p.nulls+'\\.'+this.p.nulls+')\x20(?:('+this.p.tag+this.p.letters_upper+this.p.nulls+'\\.'+this.p.nulls+')\x20)?('+this.p.tag+this.p.letters_upper+this.p.letters_lower+'+)','g',function(a,b,c,d){return b+t.e.nbsp[0]+(c?c+t.e.nbsp[0]:'')+d});this.replace('&_;','g',this.e.nbsp[0]);this.replace('('+this.p.letters_upper+this.p.nulls+'\\.'+this.p.nulls+')\x20(?='+this.p.tag+this.p.letters_upper+'{1,'+this.params.symbols_number_for_nbsp+'}\\.)','g','$1'+this.e.nbsp[0]);this.replace('('+this.p.letters_lower+this.p.nulls+'\\.'+this.p.nulls+')\x20(?='+this.p.tag+'(?:'+this.p.letters_lower+'{1,'+this.params.symbols_number_for_nbsp+'}|'+this.p.number+')(?:'+this.p.word_end_1+'|'+this.p.nulls+'(?:\\s|$)))','g','$1'+this.e.nbsp[0]);return},dash_process:function(){this.replace('((?:^|\\s|'+this.e.nbsp[0]+')'+this.p.word_begin_0+'\\$?'+this.p.number+this.p.tag+')\\—(?='+this.p.tag+this.p.number+'(?:'+this.p.word_end_0s+'|-'+this.p.letters+'{1,2}'+this.p.word_end_0s+'))','g','$1'+this.e.ndash[0]);this.replace('((?:^|\\s|'+this.e.nbsp[0]+')'+this.p.word_begin_0+this.p.roman_number+this.p.tag+')\\—(?='+this.p.tag+this.p.roman_number+'(?:'+this.p.word_end_0s+'|-'+this.p.letters+'{1,2}'+this.p.word_end_0s+'))','g','$1'+this.e.ndash[0]);this.replace('(\x20|'+this.e.nbsp[0]+')(?:'+this.p.tag+')-(\\d)','gi','$1'+this.e.minus[0]+'$2');this.replace('('+this.e.nbsp[0]+this.e.mdash[0]+')'+this.e.nbsp[0],'g','$1\x20');return},place_quotation:function(a,b){var t,LQ,RQ,Lq,Rq;t=a.split(' ');LQ=this.e[t[0]][0];RQ=this.e[t[1]][0];if(t[0]!='quot'&&t[1]!='quot'){this.replace_cyclic('('+this.p.word_begin_0s+'|[-\\.])(")((?!'+this.p.tag+'(?:\\s|'+this.e.nbsp[0]+'))[^"]{1,1900}?(?!(?:\\s|'+this.e.nbsp[0]+')'+this.p.tag+')[^"]{0,100})\\2(?='+this.p.tag+'(?:'+this.p.word_end_1s+'|'+this.p.word_end_0s+'|[-\\*]|'+this.p.tag_1+'\\d'+this.p.tag_1+'))','g','$1'+LQ+'$3'+RQ)}t=b.split(' ');Lq=this.e[t[0]][0];Rq=this.e[t[1]][0];if(LQ!=Lq&&RQ!=Rq){this.replace_cyclic('('+LQ+'[^'+LQ+RQ+']{0,2000})'+LQ+'([^'+LQ+RQ+']{0,2000})'+RQ,'g','$1'+Lq+'$2'+Rq)}this.replace('"(\\S[^"'+LQ+Lq+RQ+Rq+']*)(['+LQ+Lq+'])','g','$2$1$2');return},post_process:function(){this.replace('(\\d\\s*)(\')(?='+this.p.word_end_0s+')','g','$1'+this.e.prime[0]);this.replace('(\\d\\s*)(\\")(?='+this.p.word_end_0s+')','g','$1'+this.e.Prime[0]);this.replace('\\\'','g',this.e.rsquo[0]);return},return_html:function(){this.text=reformator.html.replace_entities(this.text,{type:this.params.entity_type_for_special,group:'special'});this.text=reformator.html.replace_entities(this.text,{type:this.params.entity_type});if(this.params.entity_type!=this.params.entity_type_for_nbsp){this.replace(this.e.nbsp[this.params.entity_type],'g',this.e.nbsp[this.params.entity_type_for_nbsp])}if(this.params.entity_type!=this.params.entity_type_for_shy){this.replace(this.e.shy[this.params.entity_type],'g',this.e.shy[this.params.entity_type_for_shy])}if(!this.params.no_tags){var t=this;this.replace_cyclic('(\x0A?)'+this.p.tag_begin+'(\\d+)'+this.p.tag_end,'g',function(a,b,c){var s=t.tags[c];return s.indexOf('\x0A')==0?s.substr(1):b+s});this.replace('(<sup(\\s[^>]*)?>'+this.e.reg[this.params.entity_type]+'(\\s+|'+this.e.nbsp[this.params.entity_type_for_nbsp]+')?</sup>|'+this.e.reg[this.params.entity_type]+')','g','<sup class="reg">'+this.e.reg[this.params.entity_type]+'</sup>$3')}else{this.replace_cyclic(this.p.tag_begin+'(\\d+)'+this.p.tag_end,'g',function(a,b){return t.tags[b]})}return},close_nobr:function(){if(!this.params.no_tags){this.replace_cyclic('(<nobr[^>]*>(?!<nobr))(<(\\/?\\w+)(\\s+[^>]*)*>)(?![^\\s]*</\\3>)','g','$2$1');this.replace_cyclic('(<nobr[^>]*>)(<nobr[^>]*>)','g','$1');this.replace('(<nobr[^>]*>(?:<(\\w+)(?:\\s+[^>]*)*>(?:.|\n)*?</\\2>|\\s*<[a-z][^>]*\\/>\\s*|[^<\\s]+?)+)(<[a-z][^>]*\\/>)?','g','$1</nobr>$3');this.replace_cyclic('(<nobr[^>]*>)(<(\\w+)(\\s+[^>]*)?>)(\\S*?)(</\\3>)(</nobr>)(\\s|$)','g','$2$1$5$7$6$8');var r=this.make_regular_expression('('+this.e.nbsp[this.params.entity_type_for_nbsp]+'|<\\/?nobr[^>]*>)+','g');var e=this.make_regular_expression('</?[a-z][^>]*>','gi');this.replace('(<nobr[^>]*>)((?:.|\n)*?)(</nobr>)','g',function(a,b,c,d){c=c.replace(r,'\x20');return(c.replace(e,'').length<30)?b+c+d:c});this.replace('<\\/nobr><nobr[^>]*>','g','')}},replace_cyclic:function(a,b,c){var d=this.make_regular_expression(a,b);while(this.text.match(d)){this.text=this.text.replace(d,c)}return},replace:function(a,b,c){var d=this.make_regular_expression(a,b);this.text=this.text.replace(d,c);return},match:function(a,b){return this.text.match(this.make_regular_expression(regexp,b))},patterns:[],make_regular_expression:function(a,b){var c=a+' '+b;if(!this.patterns[c]){try{this.patterns[c]=new RegExp(a,b)}catch(error){}}return this.patterns[c]},init:function(){this.inited=true;if(!reformator.language.inited){reformator.language.init()}if(!reformator.html.inited){reformator.html.init()}this.e=reformator.html.entities.common;this.p={};this.p.tag_begin='\x02';this.p.tag_end='\x02';this.p.tag='(?:'+this.p.tag_begin+'\\d+'+this.p.tag_end+')*';this.p.tag_1='(?:'+this.p.tag_begin+'\\d+'+this.p.tag_end+')+';this.p.nulls=this.p.tag+'(?:[ª®°¹²³´¶™+−±\\*\\/]'+this.p.tag+'){0,4}';this.p.sentence_end_symbols='\\.\\:\\;\\!\\?…';this.p.sentence_end='(?:'+this.p.tag+'['+this.p.sentence_end_symbols+']+'+this.p.tag+')';this.p.word_end_s=this.p.nulls+'(?:[\\s'+this.e.nbsp[0]+']+|$)';this.p.word_end=this.p.nulls+'(?:[%\\\x29\\\x5d\\\x7d>\\,\\"'+this.p.sentence_end_symbols+']{1,6}'+this.p.nulls+')';this.p.word_end_1=this.p.word_end+'{1,4}';this.p.word_end_1s=this.p.word_end_1+this.p.word_end_s;this.p.word_end_0=this.p.word_end+'{0,4}';this.p.word_end_0s=this.p.word_end_0+this.p.word_end_s;this.p.word_begin_s='[\\s'+this.e.nbsp[0]+']';this.p.word_begin_1='(?:'+this.p.nulls+'[\\\x28\\\x5b\\\x7b<\\"\°\+]{1,4}'+this.p.nulls+')';this.p.word_begin_1s=this.p.word_begin_s+this.p.word_begin_1+'{1,4}';this.p.word_begin_2='(?:'+this.p.nulls+'[\\\x28\\\x5b\\\x7b<]{1,4}'+this.p.nulls+')';this.p.word_begin_2s=this.p.word_begin_s+this.p.word_begin_2+'{1,4}';this.p.word_begin_0=this.p.nulls+this.p.word_begin_1+'?'+this.p.nulls;this.p.word_begin_0s=this.p.word_begin_s+this.p.word_begin_0;this.p.letters_lower=reformator.language.lower_letters+'&%©\\$€£¥¤'+String.fromCharCode(769);this.p.letters_upper=reformator.language.upper_letters;this.p.not_letters_upper='[^'+this.p.letters_upper+']';this.p.letters=this.p.letters_lower+this.p.letters_upper;this.p.letters_digits='[\\d'+this.p.letters+']';this.p.letters_lower='['+this.p.letters_lower+']';this.p.letters_upper='['+this.p.letters_upper+']';this.p.letters='['+this.p.letters+']';this.p.number='(?:[#\\.\\,\\+\\-±−]?(?:\\d+(?:[\\.\\,\\:]\\d+)*|[¼½¾]))';this.p.roman_number='(?:[IXCMVLD]+(?![ABEFGHJKNOPQRSTUWYZ]))';this.p.exceptions_left='(?:бы|б|же|ж|ли|ль|us)';this.p.exceptions_right='(?:и|до|по|от|за|из|to|by|in|of)';return}};